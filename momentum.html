<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Momentum - Reclaim Your Focus And Live Better</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Lora:wght@400;500;600;700&family=Roboto+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #0D1117;
            --card-bg-color: rgba(22, 27, 34, 0.8);
            --border-color: #30363D;
            --text-color: #E6EDF3;
            --text-muted-color: #8B949E;
            --primary-gradient-start: #2DD4BF;
            --primary-gradient-end: #3B82F6;
            --secondary-gradient-start: #9333EA;
            --secondary-gradient-end: #EC4899;
        }

        .font-inter { font-family: 'Inter', sans-serif; }
        .font-roboto-mono { font-family: 'Roboto Mono', monospace; }
        .font-lora { font-family: 'Lora', serif; }

        body {
            background-color: var(--bg-color);
            background-size: cover;
            background-attachment: fixed;
            padding-bottom: 80px;
            color: var(--text-color);
        }
        .task-item-enter { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .streak-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .sparkle { animation: sparkle-animation 2s ease-in-out infinite; }
        @keyframes sparkle-animation {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.8; }
        }
        .shake { animation: shake-animation 0.4s; }
        @keyframes shake-animation {
            0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); }
        }
        .modal-enter { animation: modal-fade-in 0.3s ease-out; }
        @keyframes modal-fade-in { from { opacity: 0; } to { opacity: 1; } }
        .modal-content-enter { animation: modal-content-slide-in 0.3s ease-out; }
        @keyframes modal-content-slide-in { from { transform: translateY(20px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        @keyframes complete-pop { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
        
        .day-circle.completed {
            background-image: linear-gradient(to right, var(--primary-gradient-start), var(--primary-gradient-end));
            border-color: var(--primary-gradient-start);
            color: #ffffff;
            animation: complete-pop 0.3s ease-out;
        }
        .day-circle.today { border-color: #60A5FA; }
        .nav-btn.active { color: #60A5FA; border-top-color: #60A5FA; }
        .mood-btn.selected { background-color: #1E40AF; transform: scale(1.2); box-shadow: 0 0 15px rgba(96, 165, 250, 0.5); }
        .timer-btn { background-color: #374151; padding: 0.25rem 0.75rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 600; transition: all 0.2s; border: 1px solid #4B5563; }
        .timer-btn:hover { background-color: #4B5563; box-shadow: 0 0 8px rgba(96, 165, 250, 0.4); }
        
        .card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(8px);
            transition: all 0.2s ease-in-out;
        }
        .card:hover { transform: translateY(-2px); border-color: #484F58; }
        .task-card { background-color: var(--card-bg-color); border: 1px solid var(--border-color); }
        
        .input-base {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        .input-base:focus { outline: none; border-color: #60A5FA; box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.3); }
        
        .primary-btn { background-image: linear-gradient(to right, var(--primary-gradient-start), var(--primary-gradient-end)); transition: all 0.3s ease; }
        .primary-btn:hover { box-shadow: 0 0 15px rgba(45, 212, 191, 0.4); transform: translateY(-1px); }
        .secondary-btn { background-image: linear-gradient(to right, var(--secondary-gradient-start), var(--secondary-gradient-end)); transition: all 0.3s ease; }
        .secondary-btn:hover { box-shadow: 0 0 15px rgba(236, 72, 153, 0.4); transform: translateY(-1px); }
        
        .xp-bar-bg { background-color: var(--border-color); }
        .xp-bar-fg { background-image: linear-gradient(to right, var(--primary-gradient-start), var(--primary-gradient-end)); transition: width 0.5s ease-out; }

        @keyframes reward-fade-out { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-20px); } }
        .reward-popup { animation: reward-fade-out 1.5s ease-out forwards; }
        
        .theme-swatch, .font-btn, .bg-thumbnail {
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .theme-swatch.selected, .font-btn.selected, .bg-thumbnail.selected {
            border-color: #60A5FA;
            box-shadow: 0 0 10px rgba(96, 165, 250, 0.5);
        }
    </style>
</head>
<body class="antialiased">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-[#0D1117] bg-opacity-80 flex items-center justify-center z-50 hidden">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-teal-400 mx-auto"></div>
            <p id="loading-message" class="text-white text-lg mt-4">Loading...</p>
        </div>
    </div>
    
    <!-- Proof of Completion Modal -->
    <div id="proof-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-40 hidden modal-enter">
        <div class="card rounded-xl p-6 w-11/12 max-w-md shadow-lg modal-content-enter">
            <h2 class="text-2xl font-bold mb-4 text-white">Proof of Completion</h2>
            <p class="text-gray-400 mb-4">For task: "<span id="proof-task-name" class="font-semibold text-teal-300"></span>"</p>
            <textarea id="proof-input" placeholder="Add any notes or feedback on this task (optional)" class="w-full input-base placeholder-gray-500 rounded-lg p-3 h-28 transition"></textarea>
            
            <div class="mt-4">
                <label for="proof-file-input" class="w-full text-center bg-[#30363D] hover:bg-[#484F58] text-white font-bold py-2 px-4 rounded-lg transition cursor-pointer inline-block">
                    📎 Attach File (Optional)
                </label>
                <input type="file" id="proof-file-input" class="hidden">
                <p id="file-name-display" class="text-sm text-gray-500 mt-2 text-center truncate"></p>
            </div>

            <div class="flex justify-end gap-3 mt-4">
                <button id="cancel-proof-btn" class="bg-[#30363D] hover:bg-[#484F58] text-white font-bold py-2 px-4 rounded-lg transition">Cancel</button>
                <button id="confirm-proof-btn" class="primary-btn text-white font-bold py-2 px-4 rounded-lg">Complete Task</button>
            </div>
        </div>
    </div>
    
    <!-- View Proof Modal -->
    <div id="view-proof-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-40 hidden modal-enter">
        <div class="card rounded-xl p-6 w-11/12 max-w-md shadow-lg modal-content-enter">
            <h2 class="text-2xl font-bold mb-4 text-white">Task Proof</h2>
            <p class="text-gray-400 mb-2">For task: "<span id="view-proof-task-name" class="font-semibold text-teal-300"></span>"</p>
            
            <div id="view-proof-file-container" class="mb-3"></div>
            
            <div class="bg-[#0D1117] rounded-lg p-3 border border-[#30363D]">
                <p id="view-proof-text" class="text-white whitespace-pre-wrap"></p>
            </div>
            <div class="flex justify-end mt-4">
                <button id="close-view-proof-btn" class="primary-btn text-white font-bold py-2 px-4 rounded-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- Generic Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden modal-enter">
        <div class="card rounded-xl p-6 w-11/12 max-w-sm shadow-lg modal-content-enter text-center">
            <h2 id="confirm-modal-title" class="text-xl font-bold mb-3 text-white">Are you sure?</h2>
            <p id="confirm-modal-text" class="text-gray-400 mb-6">This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-modal-cancel-btn" class="bg-[#30363D] hover:bg-[#484F58] text-white font-bold py-2 px-6 rounded-lg transition">Cancel</button>
                <button id="confirm-modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Fact Modal -->
    <div id="fact-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden modal-enter">
        <div class="card rounded-xl p-6 w-11/12 max-w-sm shadow-lg modal-content-enter text-center">
            <h2 class="text-xl font-bold mb-3 text-transparent bg-clip-text bg-gradient-to-r from-teal-300 to-blue-500">Momentum Boost!</h2>
            <p id="fact-text" class="text-gray-300 mb-6"></p>
            <button id="close-fact-btn" class="primary-btn text-white font-bold py-2 px-6 rounded-lg transition">Continue</button>
        </div>
    </div>
    
    <!-- Header -->
    <header class="text-center my-8 container mx-auto max-w-lg px-4">
        <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-teal-300 to-blue-500">Momentum</h1>
        <p class="text-gray-400 mt-2 text-lg">Reclaim your day, one task at a time.</p>
    </header>

    <!-- Page Views Container -->
    <div id="page-container">
        <!-- Today View -->
        <div id="today-view" class="page-view container mx-auto max-w-lg p-4">
            <!-- Stats Container -->
            <div class="card rounded-xl p-6 mb-6 shadow-lg">
                <div class="flex justify-between items-start">
                    <!-- Streak Display -->
                    <div class="flex items-center space-x-4">
                         <i data-lucide="zap" class="text-yellow-400 streak-symbol w-12 h-12"></i>
                        <div>
                            <span id="streak-count" class="text-5xl font-extrabold text-white">0</span>
                            <p class="text-gray-400 font-medium">Day Streak</p>
                        </div>
                    </div>
                    <!-- Gem Display -->
                    <div class="flex items-center space-x-2 bg-[#0D1117] px-4 py-2 rounded-full border border-[#30363D]">
                        <i data-lucide="gem" class="w-6 h-6 text-teal-400"></i>
                        <span id="gem-count" class="text-2xl font-bold">0</span>
                    </div>
                </div>

                <!-- XP Bar -->
                 <div class="mt-6">
                    <div class="flex justify-between items-center mb-1">
                        <span id="level-display" class="font-bold text-teal-400">Level 1</span>
                        <span id="xp-display" class="text-sm text-gray-400">0 / 100 XP</span>
                    </div>
                    <div class="w-full xp-bar-bg rounded-full h-2.5">
                        <div id="xp-bar" class="xp-bar-fg h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>

                <p id="streak-message" class="text-center text-blue-400 mt-4 text-sm font-medium">Complete at least 3 tasks today to keep your streak alive!</p>
                
                <!-- Weekly Progress -->
                <div class="mt-6 pt-6 border-t border-[#30363D]">
                    <h3 class="text-center font-semibold text-gray-300 mb-3">This Week's Momentum</h3>
                    <div id="weekly-progress-container" class="flex justify-around">
                        <!-- Day circles will be injected here by JS -->
                    </div>
                </div>
            </div>

            <!-- Suggestions Container -->
            <div id="suggestions-container" class="mb-6"></div>

            <!-- Main Content -->
            <main>
                <div id="task-list" class="space-y-3">
                    <!-- Tasks will be injected here by JavaScript -->
                </div>
                <p id="empty-state" class="text-center text-gray-500 py-10 hidden flex-col items-center justify-center"><i data-lucide="sun" class="w-16 h-16 mb-4 text-gray-600"></i>Your day is clear. Add a task to get started!</p>
            </main>

            <!-- Task Input -->
            <footer class="mt-6">
                <form id="task-form" class="flex items-center gap-2">
                    <input type="text" id="task-input" placeholder="e.g., Plan my weekend trip" class="w-full input-base placeholder-gray-500 rounded-lg px-4 py-3 transition">
                    <button type="submit" id="add-task-btn" class="primary-btn text-white font-bold py-3 px-5 rounded-lg whitespace-nowrap">Add</button>
                    <button type="button" id="suggest-tasks-btn" class="secondary-btn text-white font-bold py-3 px-5 rounded-lg flex items-center gap-2 whitespace-nowrap">
                        <span class="sparkle">✨</span> Suggest
                    </button>
                </form>
            </footer>
        </div>

        <!-- Journey View -->
        <div id="journey-view" class="page-view container mx-auto max-w-lg p-4 hidden">
             <div class="card rounded-xl p-6 shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-white">Productivity Stats</h2>
                    <div class="relative">
                        <button id="chart-dropdown-btn" class="bg-[#0D1117] border border-[#30363D] rounded-lg px-3 py-1.5 text-sm font-semibold flex items-center gap-2">
                            <span id="chart-dropdown-label">This Week</span>
                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                        </button>
                        <div id="chart-dropdown-menu" class="absolute right-0 mt-2 w-40 bg-[#161B22] border border-[#30363D] rounded-lg shadow-xl hidden z-10">
                            <a href="#" data-period="today" class="chart-period-option block px-4 py-2 text-sm text-gray-300 hover:bg-[#30363D]">Today</a>
                            <a href="#" data-period="week" class="chart-period-option block px-4 py-2 text-sm text-gray-300 hover:bg-[#30363D]">This Week</a>
                            <a href="#" data-period="month" class="chart-period-option block px-4 py-2 text-sm text-gray-300 hover:bg-[#30363D]">This Month</a>
                            <a href="#" data-period="year" class="chart-period-option block px-4 py-2 text-sm text-gray-300 hover:bg-[#30363D]">This Year</a>
                        </div>
                    </div>
                </div>
                <canvas id="task-chart"></canvas>
            </div>
             <div class="card rounded-xl p-6 shadow-lg mb-6">
                <h2 class="text-2xl font-bold mb-4 text-white text-center">Your Journey</h2>
                <div id="journey-list" class="space-y-4 max-h-96 overflow-y-auto">
                    <!-- Journey items will be injected here -->
                </div>
                 <p id="journey-empty-state" class="text-center text-gray-500 py-10 hidden">Complete a day's tasks to start your journey!</p>
            </div>
            <div id="achievements-container" class="card rounded-xl p-6 shadow-lg">
                 <h2 class="text-2xl font-bold mb-4 text-white text-center">Achievements</h2>
                 <div id="achievements-list" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                    <!-- Achievements will be injected here -->
                 </div>
            </div>
        </div>

        <!-- Fitness View -->
        <div id="fitness-view" class="page-view container mx-auto max-w-lg p-4 hidden">
            <div class="space-y-6">
                <h2 class="text-3xl font-bold text-white text-center">Fitness & Wellbeing</h2>

                <!-- BMI Calculator Card -->
                <div class="card rounded-xl p-6 shadow-lg">
                    <h3 class="font-semibold text-lg mb-4 text-center text-white flex items-center justify-center gap-2"><i data-lucide="calculator"></i> BMI Calculator</h3>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="height-ft-input" class="block text-sm font-medium text-gray-400">Height (ft)</label>
                            <input type="number" id="height-ft-input" class="mt-1 input-base rounded-lg block w-full p-2.5" placeholder="5">
                        </div>
                        <div>
                            <label for="height-in-input" class="block text-sm font-medium text-gray-400">Height (in)</label>
                            <input type="number" id="height-in-input" class="mt-1 input-base rounded-lg block w-full p-2.5" placeholder="9">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="weight-kg-input" class="block text-sm font-medium text-gray-400">Weight (kg)</label>
                        <input type="number" id="weight-kg-input" class="mt-1 input-base rounded-lg block w-full p-2.5" placeholder="70">
                    </div>
                    <button id="calculate-bmi-btn" class="w-full primary-btn text-white font-bold py-2 px-4 rounded-lg">Calculate BMI</button>
                    <div id="bmi-result-container" class="text-center mt-4 hidden">
                        <p class="text-gray-400">Your BMI is:</p>
                        <p id="bmi-result-value" class="text-3xl font-bold text-white"></p>
                        <p id="bmi-result-category" class="font-semibold"></p>
                    </div>
                </div>

                <!-- Water Intake Card -->
                <div class="card rounded-xl p-6 shadow-lg">
                    <h3 class="font-semibold text-lg mb-4 text-center text-white flex items-center justify-center gap-2"><i data-lucide="glass-water"></i> Water Intake</h3>
                    <div class="flex items-center justify-center gap-4">
                        <button id="decrease-water-btn" class="bg-[#30363D] hover:bg-[#484F58] rounded-full h-12 w-12 text-2xl font-bold flex items-center justify-center transition active:scale-95">-</button>
                        <div id="water-intake-display" class="text-4xl font-bold w-24 text-center">0</div>
                        <button id="increase-water-btn" class="bg-[#30363D] hover:bg-[#484F58] rounded-full h-12 w-12 text-2xl font-bold flex items-center justify-center transition active:scale-95">+</button>
                    </div>
                    <p class="text-center text-gray-400 mt-2">glasses</p>
                </div>

                <!-- Mindful Minutes Card -->
                <div class="card rounded-xl p-6 shadow-lg">
                     <h3 class="font-semibold text-lg mb-4 text-center text-white flex items-center justify-center gap-2"><i data-lucide="brain-circuit"></i> Mindful Minutes</h3>
                     <div class="flex items-center justify-center gap-4">
                        <button id="decrease-mindfulness-btn" class="bg-[#30363D] hover:bg-[#484F58] rounded-full h-12 w-12 text-2xl font-bold flex items-center justify-center transition active:scale-95">-</button>
                        <div id="mindfulness-display" class="text-4xl font-bold w-24 text-center">0</div>
                        <button id="increase-mindfulness-btn" class="bg-[#30363D] hover:bg-[#484F58] rounded-full h-12 w-12 text-2xl font-bold flex items-center justify-center transition active:scale-95">+</button>
                    </div>
                    <p class="text-center text-gray-400 mt-2">minutes</p>
                </div>

                <!-- Mood Tracker Card -->
                <div class="card rounded-xl p-6 shadow-lg">
                     <h3 class="font-semibold text-lg mb-4 text-center text-white flex items-center justify-center gap-2"><i data-lucide="smile"></i> Daily Mood</h3>
                     <div id="mood-tracker" class="flex justify-around">
                         <button data-mood="happy" class="mood-btn text-4xl p-2 rounded-full transition-transform duration-200">😄</button>
                         <button data-mood="neutral" class="mood-btn text-4xl p-2 rounded-full transition-transform duration-200">😐</button>
                         <button data-mood="sad" class="mood-btn text-4xl p-2 rounded-full transition-transform duration-200">😔</button>
                         <button data-mood="excited" class="mood-btn text-4xl p-2 rounded-full transition-transform duration-200">🤩</button>
                         <button data-mood="tired" class="mood-btn text-4xl p-2 rounded-full transition-transform duration-200">😴</button>
                     </div>
                </div>

                 <!-- Daily Activity Card -->
                <div class="card rounded-xl p-6 shadow-lg">
                    <h3 class="font-semibold text-lg mb-2 text-center text-white flex items-center justify-center gap-2"><i data-lucide="activity"></i> Today's Activity</h3>
                    <textarea id="activity-input" placeholder="e.g., 30 min run, evening walk..." class="w-full input-base placeholder-gray-500 rounded-lg p-3 h-24 transition"></textarea>
                    <button id="save-activity-btn" class="w-full mt-3 primary-btn text-white font-bold py-2 px-4 rounded-lg">Save Activity</button>
                </div>
            </div>
        </div>

        <!-- Shop View -->
        <div id="shop-view" class="page-view container mx-auto max-w-lg p-4 hidden">
             <div class="space-y-6">
                <h2 class="text-3xl font-bold text-white text-center">The Gem Shop</h2>
                
                <div class="card rounded-xl p-6 shadow-lg">
                    <div class="flex items-start gap-4">
                        <div class="bg-blue-900/50 p-3 rounded-lg"><i data-lucide="snowflake" class="w-10 h-10 text-blue-300"></i></div>
                        <div>
                            <h3 class="text-xl font-bold text-white">Streak Freeze</h3>
                            <p class="text-gray-400 text-sm mt-1">Miss a day without losing your streak. You currently have <span id="streak-freeze-count" class="font-bold text-white">0</span>.</p>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-[#30363D] flex justify-between items-center">
                         <p class="text-lg font-bold flex items-center gap-2"><i data-lucide="gem" class="w-5 h-5 text-teal-400"></i> 50</p>
                         <button id="buy-streak-freeze-btn" class="primary-btn text-white font-bold py-2 px-5 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none">Buy</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings View -->
        <div id="settings-view" class="page-view container mx-auto max-w-lg p-4 hidden">
            <div class="space-y-6">
                <div class="card rounded-xl p-6 shadow-lg space-y-6">
                    <h2 class="text-2xl font-bold text-white text-center">Settings</h2>
                    
                    <div>
                        <label for="streak-goal-input" class="block mb-2 text-sm font-medium text-gray-300">Daily Streak Goal</label>
                        <input type="number" id="streak-goal-input" min="1" class="input-base rounded-lg block w-full p-2.5" placeholder="3">
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold text-red-400">Danger Zone</h3>
                        <p class="text-sm text-gray-400 mb-3">This action cannot be undone.</p>
                        <button id="clear-data-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">Clear All App Data</button>
                    </div>
                </div>

                <div class="card rounded-xl p-6 shadow-lg space-y-6">
                    <h2 class="text-2xl font-bold text-white text-center">Customization</h2>
                    
                    <!-- Theme Customization -->
                    <div>
                        <h3 class="text-lg font-semibold mb-3">Color Theme</h3>
                        <div id="theme-swatches" class="flex gap-4">
                            <button data-theme="momentum" class="theme-swatch w-10 h-10 rounded-full bg-gradient-to-br from-teal-400 to-blue-500"></button>
                            <button data-theme="crimson" class="theme-swatch w-10 h-10 rounded-full bg-gradient-to-br from-red-500 to-pink-500"></button>
                            <button data-theme="amber" class="theme-swatch w-10 h-10 rounded-full bg-gradient-to-br from-yellow-400 to-orange-500"></button>
                            <button data-theme="violet" class="theme-swatch w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-indigo-500"></button>
                        </div>
                    </div>
                    
                    <!-- Font Customization -->
                    <div>
                        <h3 class="text-lg font-semibold mb-3">Font Style</h3>
                        <div id="font-buttons" class="flex gap-2">
                            <button data-font="inter" class="font-btn flex-1 p-2 rounded-lg bg-[#0D1117] border border-[#30363D] font-inter">Modern</button>
                            <button data-font="roboto-mono" class="font-btn flex-1 p-2 rounded-lg bg-[#0D1117] border border-[#30363D] font-roboto-mono">Mono</button>
                            <button data-font="lora" class="font-btn flex-1 p-2 rounded-lg bg-[#0D1117] border border-[#30363D] font-lora">Serif</button>
                        </div>
                    </div>

                    <!-- Background Customization -->
                    <div>
                         <h3 class="text-lg font-semibold mb-3">Background Image</h3>
                         <div id="bg-thumbnails" class="grid grid-cols-3 gap-2 mb-3">
                            <button class="bg-thumbnail w-full h-16 rounded-md bg-cover bg-center" data-bg="https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1471&q=80" style="background-image: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1471&q=80')"></button>
                            <button class="bg-thumbnail w-full h-16 rounded-md bg-cover bg-center" data-bg="https://images.unsplash.com/photo-1506280489332-8c838e4a45a2?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1074&q=80" style="background-image: url('https://images.unsplash.com/photo-1506280489332-8c838e4a45a2?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1074&q=80')"></button>
                            <button class="bg-thumbnail w-full h-16 rounded-md bg-cover bg-center" data-bg="https://images.unsplash.com/photo-1536633973623-61783353683a?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80" style="background-image: url('https://images.unsplash.com/photo-1536633973623-61783353683a?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80')"></button>
                            <button class="bg-thumbnail w-full h-16 rounded-md bg-cover bg-center" data-bg="https://images.unsplash.com/photo-1554189097-9e36506f3604?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1470&q=80" style="background-image: url('https://images.unsplash.com/photo-1554189097-9e36506f3604?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1470&q=80')"></button>
                            <button class="bg-thumbnail w-full h-16 rounded-md bg-cover bg-center" data-bg="https://images.unsplash.com/photo-1488866022504-f2584929ca5f?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1470&q=80" style="background-image: url('https://images.unsplash.com/photo-1488866022504-f2584929ca5f?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1470&q=80')"></button>
                         </div>
                         <div class="flex gap-2">
                             <input type="text" id="custom-bg-input" class="input-base w-full rounded-lg px-3 py-2" placeholder="Paste image URL...">
                             <button id="apply-custom-bg-btn" class="primary-btn text-white font-bold py-2 px-4 rounded-lg">Apply</button>
                         </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-opacity-70 backdrop-blur-lg bg-[#161B22] border-t border-[#30363D]">
        <div class="flex justify-around max-w-lg mx-auto">
            <button data-view="today" class="nav-btn active flex-1 py-4 px-2 text-center font-semibold text-gray-400 transition border-t-2 border-transparent">Today</button>
            <button data-view="journey" class="nav-btn flex-1 py-4 px-2 text-center font-semibold text-gray-400 transition border-t-2 border-transparent">Journey</button>
            <button data-view="fitness" class="nav-btn flex-1 py-4 px-2 text-center font-semibold text-gray-400 transition border-t-2 border-transparent">Fitness</button>
            <button data-view="shop" class="nav-btn flex-1 py-4 px-2 text-center font-semibold text-gray-400 transition border-t-2 border-transparent">Shop</button>
            <button data-view="settings" class="nav-btn flex-1 py-4 px-2 text-center font-semibold text-gray-400 transition border-t-2 border-transparent">Settings</button>
        </div>
    </nav>


    <script>
        // DOM Elements
        const taskForm = document.getElementById('task-form');
        const taskInput = document.getElementById('task-input');
        const taskList = document.getElementById('task-list');
        const emptyState = document.getElementById('empty-state');
        const streakCountEl = document.getElementById('streak-count');
        const streakMessageEl = document.getElementById('streak-message');
        const weeklyProgressContainer = document.getElementById('weekly-progress-container');
        const addTaskBtn = document.getElementById('add-task-btn');
        const suggestTasksBtn = document.getElementById('suggest-tasks-btn');
        const suggestionsContainer = document.getElementById('suggestions-container');
        const gemCountEl = document.getElementById('gem-count');
        const levelDisplay = document.getElementById('level-display');
        const xpDisplay = document.getElementById('xp-display');
        const xpBar = document.getElementById('xp-bar');
        // Page elements
        const pageContainer = document.getElementById('page-container');
        const bottomNav = document.getElementById('bottom-nav');
        // Journey elements
        const journeyList = document.getElementById('journey-list');
        const journeyEmptyState = document.getElementById('journey-empty-state');
        const achievementsList = document.getElementById('achievements-list');
        const chartDropdownBtn = document.getElementById('chart-dropdown-btn');
        const chartDropdownLabel = document.getElementById('chart-dropdown-label');
        const chartDropdownMenu = document.getElementById('chart-dropdown-menu');
        const taskChartCanvas = document.getElementById('task-chart');
        // Fitness elements
        const decreaseWaterBtn = document.getElementById('decrease-water-btn');
        const increaseWaterBtn = document.getElementById('increase-water-btn');
        const waterIntakeDisplay = document.getElementById('water-intake-display');
        const decreaseMindfulnessBtn = document.getElementById('decrease-mindfulness-btn');
        const increaseMindfulnessBtn = document.getElementById('increase-mindfulness-btn');
        const mindfulnessDisplay = document.getElementById('mindfulness-display');
        const moodTracker = document.getElementById('mood-tracker');
        const activityInput = document.getElementById('activity-input');
        const saveActivityBtn = document.getElementById('save-activity-btn');
        // BMI Calculator elements
        const heightFtInput = document.getElementById('height-ft-input');
        const heightInInput = document.getElementById('height-in-input');
        const weightKgInput = document.getElementById('weight-kg-input');
        const calculateBmiBtn = document.getElementById('calculate-bmi-btn');
        const bmiResultContainer = document.getElementById('bmi-result-container');
        const bmiResultValue = document.getElementById('bmi-result-value');
        const bmiResultCategory = document.getElementById('bmi-result-category');
        // Shop elements
        const buyStreakFreezeBtn = document.getElementById('buy-streak-freeze-btn');
        const streakFreezeCountEl = document.getElementById('streak-freeze-count');
        // Settings elements
        const streakGoalInput = document.getElementById('streak-goal-input');
        const clearDataBtn = document.getElementById('clear-data-btn');
        const themeSwatches = document.getElementById('theme-swatches');
        const fontButtons = document.getElementById('font-buttons');
        const bgThumbnails = document.getElementById('bg-thumbnails');
        const customBgInput = document.getElementById('custom-bg-input');
        const applyCustomBgBtn = document.getElementById('apply-custom-bg-btn');
        // Proof Modal Elements
        const proofModal = document.getElementById('proof-modal');
        const proofTaskName = document.getElementById('proof-task-name');
        const proofInput = document.getElementById('proof-input');
        const proofFileInput = document.getElementById('proof-file-input');
        const fileNameDisplay = document.getElementById('file-name-display');
        const cancelProofBtn = document.getElementById('cancel-proof-btn');
        const confirmProofBtn = document.getElementById('confirm-proof-btn');
        // View Proof Modal Elements
        const viewProofModal = document.getElementById('view-proof-modal');
        const viewProofTaskName = document.getElementById('view-proof-task-name');
        const viewProofText = document.getElementById('view-proof-text');
        const viewProofFileContainer = document.getElementById('view-proof-file-container');
        const closeViewProofBtn = document.getElementById('close-view-proof-btn');
        // Confirmation Modal Elements
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalText = document.getElementById('confirm-modal-text');
        const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn');
        const confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm-btn');
        // Fact Modal Elements
        const factModal = document.getElementById('fact-modal');
        const factText = document.getElementById('fact-text');
        const closeFactBtn = document.getElementById('close-fact-btn');

        // App State
        let state = {
            tasks: [],
            streak: 0,
            lastStreakUpdate: null, 
            completionHistory: {}, 
            currentView: 'today',
            streakGoal: 3,
            dailyData: {}, 
            gems: 0,
            streakFreezes: 0,
            level: 1,
            xp: 0,
            totalTasksCompleted: 0,
            achievements: {},
            customization: {
                theme: 'momentum',
                font: 'inter',
                background: 'https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1471&q=80',
            }
        };
        let currentTaskIndex = null; 
        let confirmCallback = null; 
        let hasShownApiKeyWarning = false;
        let taskChart = null;
        let currentChartPeriod = 'week';

        const defaultTasks = [
            "📚 Read for 15 minutes",
            "🚶‍♂️ Walk for 30 mins",
            "📅 Plan tomorrow's priorities",
            "🧘 Meditate for 5 minutes",
            "🧹 Tidy up for 10 minutes",
            "💧 Drink a glass of water"
        ];
        
        const achievementDefinitions = {
            'firstTask': { name: 'First Step', description: 'Complete your first task.', reward: 10, icon: 'footprints' },
            'streakStarter': { name: 'On a Roll', description: 'Achieve a 3-day streak.', reward: 25, icon: 'flame' },
            'streakMaster': { name: 'Unstoppable', description: 'Achieve a 7-day streak.', reward: 100, icon: 'trophy' },
            'streakAdept': { name: 'Habit Builder', description: 'Achieve a 21-day streak.', reward: 200, icon: 'calendar-check' },
            'streakExpert': { name: 'Consistency King', description: 'Achieve a 63-day streak.', reward: 500, icon: 'crown' },
            'streakLegend': { name: 'Momentum Legend', description: 'Achieve a 100-day streak.', reward: 1000, icon: 'shield-check' },
            'taskNovice': { name: 'Task Tackler', description: 'Complete 10 tasks.', reward: 20, icon: 'target' },
            'wellbeingWatcher': { name: 'Mind & Body', description: 'Log fitness data for 3 days in a row.', reward: 30, icon: 'heart-pulse' }
        };

        const facts = [
            "The 'Two-Minute Rule' states that if a task takes less than two minutes, do it now. It builds momentum for bigger tasks.",
            "Your brain's reward system releases dopamine for small wins, making you more motivated to continue. Keep checking off those tasks!",
            "Breaking a bad habit is easier when you replace it with a good one. What's a positive habit you can start today?",
            "The Pomodoro Technique (25 minutes of focused work, 5-minute break) can dramatically improve concentration and prevent burnout.",
            "Celebrating small victories reinforces positive behavior. Acknowledge your effort after each completed task!",
            "Identifying your triggers is the first step to overcoming addiction. Notice what situations lead to cravings.",
            "Mindfulness and meditation can rewire your brain, reducing stress and improving your ability to resist impulsive behaviors.",
            "Building a 'keystone habit,' like daily exercise, can cause a chain reaction of other positive habits to form.",
            "Chunking large projects into smaller, manageable tasks makes them less daunting and easier to start.",
            "Consistency is more powerful than intensity. A small daily effort is better than a large, infrequent one."
        ];

        const themes = {
            momentum: {
                '--primary-gradient-start': '#2DD4BF',
                '--primary-gradient-end': '#3B82F6',
            },
            crimson: {
                '--primary-gradient-start': '#EF4444',
                '--primary-gradient-end': '#EC4899',
            },
            amber: {
                '--primary-gradient-start': '#FBBF24',
                '--primary-gradient-end': '#F97316',
            },
            violet: {
                 '--primary-gradient-start': '#8B5CF6',
                '--primary-gradient-end': '#6366F1',
            }
        };

        // --- Date Helpers ---
        function getTodayDateString() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }

        function getYesterdayDateString() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            return yesterday.toISOString().split('T')[0];
        }
        
        // --- State & Storage ---
        function saveState() {
            localStorage.setItem('momentumState', JSON.stringify(state));
        }

        function loadState() {
            const savedState = localStorage.getItem('momentumState');
            const defaultState = {
                tasks: [],
                streak: 0,
                lastStreakUpdate: null, 
                completionHistory: {},
                currentView: 'today',
                streakGoal: 3,
                dailyData: {},
                gems: 0,
                streakFreezes: 0,
                level: 1,
                xp: 0,
                totalTasksCompleted: 0,
                achievements: {},
                customization: {
                    theme: 'momentum',
                    font: 'inter',
                    background: 'https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1471&q=80',
                }
            };

            if (savedState) {
                const loadedState = JSON.parse(savedState);
                state = { ...defaultState, ...loadedState };
                 // Ensure customization object exists
                if (!state.customization) {
                    state.customization = defaultState.customization;
                }
            } else {
                state = defaultState;
            }

            const today = getTodayDateString();
            if (!state.dailyData) {
                state.dailyData = {};
            }
            if (!state.dailyData[today]) {
                state.dailyData[today] = {
                    waterIntake: 0,
                    mindfulMinutes: 0,
                    mood: null,
                    activity: '',
                    heightFt: '',
                    heightIn: '',
                    weightKg: ''
                };
            }

            // Streak Freeze Logic
            if (state.lastStreakUpdate) {
                const todayDate = new Date(today);
                const lastUpdateDate = new Date(state.lastStreakUpdate);
                const diffTime = todayDate - lastUpdateDate;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays > 1) { // More than one day has passed
                    if (diffDays === 2 && state.streakFreezes > 0) {
                        state.streakFreezes--;
                        state.lastStreakUpdate = getYesterdayDateString(); // "Use" the freeze
                        openConfirmModal("Streak Saved!", `A streak freeze was used to protect your ${state.streak}-day streak.`, () => closeConfirmModal());
                    } else {
                        state.streak = 0;
                        state.lastStreakUpdate = null;
                    }
                }
            }
        }
        
        // --- UI & Rendering ---
        function showLoadingOverlay(message) {
            document.getElementById('loading-message').textContent = message;
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoadingOverlay() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function renderAll() {
            renderTasks();
            updateStreakDisplay();
            updateGemDisplay();
            updateXpDisplay();
            renderWeeklyProgress();
            navigateTo(state.currentView, false); 
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        
        function renderSuggestions(suggestions = defaultTasks, type = 'default') {
            suggestionsContainer.innerHTML = '';
            if (suggestions.length === 0) return;
            
            const card = document.createElement('div');
            card.className = 'card rounded-xl p-4';

            const header = document.createElement('div');
            header.className = 'flex justify-between items-center mb-3';
            
            const title = document.createElement('h3');
            title.className = "font-semibold text-gray-300";
            title.textContent = type === 'default' ? 'Momentum Starters' : 'AI Suggestions';
            header.appendChild(title);

            if (type === 'ai') {
                const clearBtn = document.createElement('button');
                clearBtn.id = 'clear-ai-suggestions';
                clearBtn.className = 'text-sm text-red-400 hover:text-red-500';
                clearBtn.textContent = 'Clear';
                header.appendChild(clearBtn);
            }
            card.appendChild(header);

            const buttonGrid = document.createElement('div');
            buttonGrid.className = "grid grid-cols-2 gap-3";
            
            suggestions.forEach(taskText => {
                const button = document.createElement('button');
                button.className = "suggestion-btn w-full bg-[#161B22] border border-[#30363D] hover:border-teal-400 text-white text-sm font-medium py-3 px-2 rounded-lg transition text-left";
                button.textContent = taskText;
                buttonGrid.appendChild(button);
            });
            card.appendChild(buttonGrid);
            suggestionsContainer.appendChild(card);
        }

        function renderTasks() {
            taskList.innerHTML = '';

            if (state.tasks.length === 0) {
                renderSuggestions();
                emptyState.style.display = 'flex';
                suggestionsContainer.classList.remove('hidden');
            } else {
                if(suggestionsContainer.querySelector('#clear-ai-suggestions') === null) {
                    suggestionsContainer.innerHTML = '';
                    suggestionsContainer.classList.add('hidden');
                }
                emptyState.style.display = 'none';
            }

            state.tasks.forEach((task, index) => {
                const taskEl = document.createElement('div');
                taskEl.className = 'task-item-enter task-card rounded-lg p-4 flex flex-col shadow-md transition-all duration-300';
                if (task.completed) taskEl.classList.add('opacity-50');

                const isTimerTask = task.durationInSeconds > 0;
                const proofButtonHtml = task.completed && (task.proof || task.proofFile) ? `
                    <button data-index="${index}" class="view-proof-btn text-gray-500 hover:text-teal-400 transition-colors flex-shrink-0 ml-2">
                         <i data-lucide="file-text" class="w-5 h-5"></i>
                    </button>
                ` : '';

                let timerHtml = '';
                if (isTimerTask) {
                    timerHtml = `
                        <div class="mt-3 pt-3 border-t border-[#30363D] flex items-center justify-between">
                            <span class="text-2xl font-mono font-semibold text-teal-300" data-timer-display-for="${index}">${formatTime(task.remainingSeconds)}</span>
                            <div class="flex items-center gap-2">
                                <button data-index="${index}" class="start-timer-btn timer-btn flex items-center gap-1 ${task.isTimerActive || task.completed ? 'hidden' : ''}"><i data-lucide="play" class="w-4 h-4"></i> Start</button>
                                <button data-index="${index}" class="pause-timer-btn timer-btn flex items-center gap-1 ${!task.isTimerActive || task.completed ? 'hidden' : ''}"><i data-lucide="pause" class="w-4 h-4"></i> Pause</button>
                                <button data-index="${index}" class="reset-timer-btn timer-btn flex items-center gap-1 ${task.completed ? 'hidden' : ''}"><i data-lucide="rotate-cw" class="w-4 h-4"></i> Reset</button>
                            </div>
                        </div>
                    `;
                }
                
                const checkboxId = `task-${index}`;
                const isDisabled = isTimerTask && !task.completed;

                taskEl.innerHTML = `
                    <div class="flex w-full items-center justify-between">
                        <div class="flex items-center w-full overflow-hidden">
                             <input type="checkbox" id="${checkboxId}" data-index="${index}" class="hidden" ${task.completed ? 'checked' : ''} ${isDisabled ? 'disabled' : ''}>
                             <label for="${checkboxId}" class="flex items-center w-full ${isDisabled ? 'cursor-not-allowed' : 'cursor-pointer'}">
                                <span class="w-6 h-6 rounded-full border-2 ${task.completed ? 'bg-gradient-to-br from-teal-400 to-blue-500 border-teal-500' : 'border-gray-600'} flex items-center justify-center transition-all duration-200 flex-shrink-0">
                                    <i data-lucide="check" class="w-4 h-4 text-white transition-opacity duration-200 ${task.completed ? 'opacity-100' : 'opacity-0'}"></i>
                                </span>
                                <span class="ml-4 text-lg truncate ${task.completed ? 'line-through text-gray-500' : 'text-white'}">${task.text}</span>
                             </label>
                        </div>
                        <div class="flex items-center">
                            ${proofButtonHtml}
                            <button data-index="${index}" class="delete-btn text-gray-500 hover:text-red-500 transition-colors flex-shrink-0 ml-2">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    ${timerHtml}
                `;
                taskList.appendChild(taskEl);
            });
            lucide.createIcons();
        }

        function updateStreakDisplay() {
            streakCountEl.textContent = state.streak;
            const completedToday = state.tasks.filter(t => t.completed).length;

            const streakSymbol = document.querySelector('.streak-symbol');
            if (streakSymbol) {
                if (state.streak > 0) {
                    streakSymbol.classList.add('streak-pulse');
                } else {
                    streakSymbol.classList.remove('streak-pulse');
                }
            }
            
            const remaining = state.streakGoal - completedToday;
            if (remaining > 0) {
                streakMessageEl.textContent = `Complete ${remaining} more task${remaining > 1 ? 's' : ''} today to continue your streak!`;
            } else {
                streakMessageEl.textContent = `Great job! You've met your goal for today! 🎉`;
            }
        }
        
        function updateGemDisplay() {
            gemCountEl.textContent = state.gems;
        }
        
        function xpForNextLevel(level) {
            return Math.floor(50 * Math.pow(level, 1.5));
        }

        function updateXpDisplay() {
            const nextLevelXp = xpForNextLevel(state.level);
            levelDisplay.textContent = `Level ${state.level}`;
            xpDisplay.textContent = `${state.xp} / ${nextLevelXp} XP`;
            xpBar.style.width = `${(state.xp / nextLevelXp) * 100}%`;
        }


        function renderWeeklyProgress() {
            weeklyProgressContainer.innerHTML = '';
            const dayLabels = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            const today = new Date();
            const todayDateString = today.toISOString().split('T')[0];
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay()); 

            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                const dayDateString = day.toISOString().split('T')[0];

                const completedCount = state.completionHistory[dayDateString] || 0;
                const isCompleted = completedCount >= state.streakGoal;
                const isToday = dayDateString === todayDateString;

                const dayEl = document.createElement('div');
                dayEl.className = 'text-center';
                
                const circleEl = document.createElement('div');
                circleEl.className = 'day-circle h-10 w-10 mx-auto rounded-full border-2 border-[#30363D] flex items-center justify-center font-bold transition-all';
                if (isCompleted) circleEl.classList.add('completed');
                if (isToday) circleEl.classList.add('today');
                
                circleEl.textContent = dayLabels[i];
                
                dayEl.appendChild(circleEl);
                weeklyProgressContainer.appendChild(dayEl);
            }
        }

        function renderJourneyView() {
            const completedDays = Object.entries(state.completionHistory)
                .filter(([_, count]) => count >= state.streakGoal)
                .map(([date, count]) => ({ date, count }))
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            journeyList.innerHTML = '';
            journeyEmptyState.classList.toggle('hidden', completedDays.length > 0);

            const moodEmojis = {
                happy: '😄',
                neutral: '😐',
                sad: '😔',
                excited: '🤩',
                tired: '😴'
            };

            completedDays.forEach(({ date, count }) => {
                const dateObj = new Date(date);
                const formattedDate = dateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' });
                const journeyItem = document.createElement('div');
                journeyItem.className = 'card p-4 rounded-lg';

                let fitnessHtml = '';
                const dailyData = state.dailyData[date];

                if (dailyData) {
                    const fitnessParts = [];
                    if (dailyData.waterIntake > 0) fitnessParts.push(`<span>💧 ${dailyData.waterIntake} glasses</span>`);
                    if (dailyData.mindfulMinutes > 0) fitnessParts.push(`<span>🧘 ${dailyData.mindfulMinutes} min</span>`);
                    if (dailyData.mood) fitnessParts.push(`<span>${moodEmojis[dailyData.mood] || ''}</span>`);
                    
                    if (fitnessParts.length > 0) {
                        fitnessHtml += `<div class="border-t border-[#30363D] pt-3 mt-3 flex flex-wrap gap-x-4 gap-y-2 text-sm text-gray-300">${fitnessParts.join('')}</div>`;
                    }
                    if (dailyData.activity) {
                        fitnessHtml += `<p class="w-full mt-2 pt-2 border-t border-[#30363D] text-gray-400 italic text-sm">🏃 ${dailyData.activity}</p>`;
                    }
                }

                journeyItem.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-white">${formattedDate}</span>
                        <span class="text-sm font-bold text-teal-400">${count} tasks</span>
                    </div>
                    ${fitnessHtml}
                `;
                journeyList.appendChild(journeyItem);
            });
            renderAchievements();
            renderChart(currentChartPeriod);
        }

        function renderAchievements() {
            achievementsList.innerHTML = '';
            for (const id in achievementDefinitions) {
                const definition = achievementDefinitions[id];
                const earned = state.achievements[id];

                const achievementEl = document.createElement('div');
                achievementEl.className = `p-4 rounded-lg flex flex-col items-center justify-center text-center transition ${earned ? 'bg-gradient-to-br from-teal-900 to-blue-900 border border-teal-500' : 'bg-[#0D1117] border border-[#30363D] opacity-60'}`;
                
                achievementEl.innerHTML = `
                    <i data-lucide="${definition.icon}" class="w-10 h-10 ${earned ? 'text-teal-400' : 'text-gray-500'}"></i>
                    <h4 class="font-bold mt-2 text-sm ${earned ? 'text-white' : 'text-gray-400'}">${definition.name}</h4>
                    <p class="text-xs text-gray-500 mt-1">${definition.description}</p>
                `;
                achievementsList.appendChild(achievementEl);
            }
            lucide.createIcons();
        }

        function getTodaysFitnessData() {
            const today = getTodayDateString();
            if (!state.dailyData[today]) {
                state.dailyData[today] = { waterIntake: 0, mindfulMinutes: 0, mood: null, activity: '', heightFt: '', heightIn: '', weightKg: '' };
            }
            return state.dailyData[today];
        }

        function renderFitnessView() {
            const fitnessData = getTodaysFitnessData();
            
            waterIntakeDisplay.textContent = fitnessData.waterIntake;
            mindfulnessDisplay.textContent = fitnessData.mindfulMinutes;
            activityInput.value = fitnessData.activity;

            heightFtInput.value = fitnessData.heightFt || '';
            heightInInput.value = fitnessData.heightIn || '';
            weightKgInput.value = fitnessData.weightKg || '';

            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.mood === fitnessData.mood);
            });
            lucide.createIcons();
        }

        function renderShopView() {
            streakFreezeCountEl.textContent = state.streakFreezes;
            buyStreakFreezeBtn.disabled = state.gems < 50;
            lucide.createIcons();
        }

        function renderSettingsView() {
            streakGoalInput.value = state.streakGoal;
            
            // Render customization options
            document.querySelectorAll('.theme-swatch').forEach(swatch => {
                swatch.classList.toggle('selected', swatch.dataset.theme === state.customization.theme);
            });
            document.querySelectorAll('.font-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.font === state.customization.font);
            });
             document.querySelectorAll('.bg-thumbnail').forEach(thumb => {
                thumb.classList.toggle('selected', thumb.dataset.bg === state.customization.background);
            });
            customBgInput.value = '';
        }
        
        function navigateTo(viewName, shouldRenderContent = true) {
            state.currentView = viewName;
            document.querySelectorAll('.page-view').forEach(view => view.classList.add('hidden'));
            document.getElementById(`${viewName}-view`).classList.remove('hidden');

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === viewName);
            });

            if(shouldRenderContent) {
                if (viewName === 'journey') renderJourneyView();
                if (viewName === 'settings') renderSettingsView();
                if (viewName === 'fitness') renderFitnessView();
                if (viewName === 'shop') renderShopView();
            }
        }
        
        // --- Modal Logic ---
        function openProofModal(index) {
            currentTaskIndex = index;
            const task = state.tasks[index];
            proofTaskName.textContent = task.text;
            proofInput.value = '';
            proofFileInput.value = null;
            fileNameDisplay.textContent = '';
            proofModal.classList.remove('hidden');
        }

        function closeProofModal() {
            proofModal.classList.add('hidden');
            currentTaskIndex = null;
        }

        function openViewProofModal(index) {
            const task = state.tasks[index];
            viewProofTaskName.textContent = task.text;
            viewProofText.textContent = task.proof || "No text proof provided.";
            viewProofFileContainer.innerHTML = '';

            if (task.proofFile && task.proofFile.data) {
                const link = document.createElement('a');
                link.href = task.proofFile.data;
                link.download = task.proofFile.name;
                link.textContent = `📎 Download: ${task.proofFile.name}`;
                link.className = 'inline-block primary-btn text-white font-bold py-2 px-4 rounded-lg';
                viewProofFileContainer.appendChild(link);
                viewProofFileContainer.classList.remove('hidden');
            } else {
                viewProofFileContainer.classList.add('hidden');
            }

            viewProofModal.classList.remove('hidden');
        }

        function closeViewProofModal() {
            viewProofModal.classList.add('hidden');
        }

        function openConfirmModal(title, text, onConfirm) {
            confirmModalTitle.textContent = title;
            confirmModalText.textContent = text;
            confirmCallback = onConfirm;
            confirmModal.classList.remove('hidden');
        }

        function closeConfirmModal() {
            confirmModal.classList.add('hidden');
            confirmCallback = null;
        }

        function showFactModal() {
            const randomFact = facts[Math.floor(Math.random() * facts.length)];
            factText.textContent = randomFact;
            factModal.classList.remove('hidden');
        }

        function closeFactModal() {
            factModal.classList.add('hidden');
        }
        
        function awardPoints(task, element) {
            let gemsAwarded = 0;
            let xpAwarded = 0;

            if (task.durationInSeconds) {
                const minutes = task.durationInSeconds / 60;
                gemsAwarded = Math.max(1, Math.ceil(minutes / 5)); 
                xpAwarded = 10 + Math.floor(minutes); 
            } else {
                gemsAwarded = 5;
                xpAwarded = 10;
            }
            state.gems += gemsAwarded;
            state.xp += xpAwarded;
            
            if (element) {
                const rect = element.getBoundingClientRect();
                const popup = document.createElement('div');
                popup.className = 'reward-popup absolute font-bold text-teal-400 z-50';
                popup.style.left = `${rect.left + rect.width / 2}px`;
                popup.style.top = `${rect.top}px`;
                popup.innerHTML = `+${gemsAwarded}<i data-lucide="gem" class="inline-block w-4 h-4 ml-1"></i> +${xpAwarded} XP`;
                document.body.appendChild(popup);
                lucide.createIcons({nodes: [popup]});
                setTimeout(() => popup.remove(), 1500);
            }

            updateGemDisplay();
            updateXpDisplay();
            checkLevelUp();
        }
        
        function checkLevelUp() {
            const nextLevelXp = xpForNextLevel(state.level);
            if (state.xp >= nextLevelXp) {
                state.level++;
                state.xp = state.xp - nextLevelXp;
                const bonusGems = 50;
                state.gems += bonusGems;
                openConfirmModal(`🎉 Level Up!`, `You've reached Level ${state.level} and earned a bonus of ${bonusGems} gems!`, () => closeConfirmModal());
                updateXpDisplay();
                updateGemDisplay();
            }
        }
        
        function checkAchievements() {
            const newAchievements = [];

            // First Task
            if (!state.achievements['firstTask'] && state.totalTasksCompleted >= 1) {
                newAchievements.push('firstTask');
            }
            // Task Novice
            if (!state.achievements['taskNovice'] && state.totalTasksCompleted >= 10) {
                newAchievements.push('taskNovice');
            }
            // Streak Starter
            if (!state.achievements['streakStarter'] && state.streak >= 3) {
                newAchievements.push('streakStarter');
            }
            // Streak Master
            if (!state.achievements['streakMaster'] && state.streak >= 7) {
                newAchievements.push('streakMaster');
            }
            // Streak Adept
            if (!state.achievements['streakAdept'] && state.streak >= 21) {
                newAchievements.push('streakAdept');
            }
            // Streak Expert
            if (!state.achievements['streakExpert'] && state.streak >= 63) {
                newAchievements.push('streakExpert');
            }
            // Streak Legend
            if (!state.achievements['streakLegend'] && state.streak >= 100) {
                newAchievements.push('streakLegend');
            }


            newAchievements.forEach(id => {
                state.achievements[id] = true;
                const achievement = achievementDefinitions[id];
                state.gems += achievement.reward;
                openConfirmModal('🏆 Achievement Unlocked!', `${achievement.name} (+${achievement.reward} gems)`, () => closeConfirmModal());
            });

            if (newAchievements.length > 0) {
                updateGemDisplay();
                if (state.currentView === 'journey') renderAchievements();
            }
        }

        // --- Core Task & Timer Logic ---
        function parseDuration(text) {
            const minutesMatch = text.match(/(\d+)\s*(minutes|minute|mins|min)/i);
            if (minutesMatch) return parseInt(minutesMatch[1]) * 60;
            const hoursMatch = text.match(/(\d+)\s*(hours|hour|hrs|hr)/i);
            if (hoursMatch) return parseInt(hoursMatch[1]) * 3600;
            return null;
        }

        async function addTask(text) {
            if (!text.trim()) return;
            const isValid = await validateTaskWithGemini(text);
            if (isValid) {
                const duration = parseDuration(text);
                const newTask = { text, completed: false, proof: null, proofFile: null };
                if (duration) {
                    newTask.durationInSeconds = duration;
                    newTask.remainingSeconds = duration;
                    newTask.timerId = null;
                    newTask.isTimerActive = false;
                }
                state.tasks.push(newTask);
                taskInput.value = '';
                taskInput.placeholder = "e.g., Plan my weekend trip";
                saveState();
                renderAll();
            } else {
                taskInput.value = '';
                taskInput.placeholder = "Please enter a real task...";
                taskInput.classList.add('shake');
                setTimeout(() => taskInput.classList.remove('shake'), 400);
            }
        }

        function toggleTask(index, element) {
            const task = state.tasks[index];
            
            if (task.completed) {
                task.completed = false;
                task.proof = null;
                task.proofFile = null;

                if (task.durationInSeconds) {
                    if (task.timerId) clearInterval(task.timerId);
                    task.isTimerActive = false;
                    task.remainingSeconds = task.durationInSeconds;
                }

                updateCompletionHistory();
                checkStreak(); 
                saveState();
                renderAll();
            } else if (!task.durationInSeconds) {
                openProofModal(index, element);
            }
        }
        
        function deleteTask(index) {
            pauseTimer(index); 
            state.tasks.splice(index, 1);
            updateCompletionHistory();
            checkStreak();
            saveState();
            renderAll();
        }

        function checkStreak() {
            const completedToday = state.tasks.filter(t => t.completed).length;
            const today = getTodayDateString();
            const yesterday = getYesterdayDateString();

            if (completedToday >= state.streakGoal) {
                if (state.lastStreakUpdate !== today) {
                    state.streak = (state.lastStreakUpdate === yesterday) ? state.streak + 1 : 1;
                    state.lastStreakUpdate = today;
                }
            }
            checkAchievements();
        }

        function updateCompletionHistory(task) {
            if (task) {
                task.completionTimestamp = new Date().toISOString();
            }
            const today = getTodayDateString();
            const completedTodayCount = state.tasks.filter(t => t.completed).length;
            state.completionHistory[today] = completedTodayCount;
            saveState();
        }
        
        async function cleanUpExistingTasks() {
            if (state.tasks.length === 0) return;
            showLoadingOverlay("Tidying up your task list...");
            const validationPromises = state.tasks.map(task => validateTaskWithGemini(task.text, false));
            const results = await Promise.all(validationPromises);
            const validatedTasks = state.tasks.filter((_, index) => results[index]);
            if (validatedTasks.length !== state.tasks.length) {
                state.tasks = validatedTasks;
                saveState();
            }
            hideLoadingOverlay();
        }
        
        function updateTimerDisplay(index) {
            const task = state.tasks[index];
            const displayEl = document.querySelector(`[data-timer-display-for="${index}"]`);
            if (displayEl) {
                displayEl.textContent = formatTime(task.remainingSeconds);
            }
        }

        function startTimer(index) {
            const task = state.tasks[index];
            if (task.isTimerActive || task.remainingSeconds <= 0) return;

            task.isTimerActive = true;
            task.timerId = setInterval(() => {
                task.remainingSeconds--;
                updateTimerDisplay(index);

                if (task.remainingSeconds <= 0) {
                    clearInterval(task.timerId);
                    task.isTimerActive = false;
                    task.completed = true;
                    task.proof = "Timer completed";
                    state.totalTasksCompleted++;
                    const taskEl = document.getElementById(`task-${index}`);
                    awardPoints(task, taskEl);
                    updateCompletionHistory(task);
                    checkStreak();
                    saveState();
                    renderAll();
                    setTimeout(showFactModal, 500);
                }
            }, 1000);
            renderAll();
        }

        function pauseTimer(index) {
            const task = state.tasks[index];
            if (!task || !task.isTimerActive) return;

            clearInterval(task.timerId);
            task.isTimerActive = false;
            renderAll();
        }

        function resetTimer(index) {
            const task = state.tasks[index];
            if (task.timerId) clearInterval(task.timerId);
            
            task.isTimerActive = false;
            task.remainingSeconds = task.durationInSeconds;
            renderAll();
        }

        // --- GEMINI API ---
        async function callGemini(userQuery, systemPrompt, generationConfig) {
            const apiKey = "AIzaSyABVfkx1OCm6xMreyraOxtp1TDWEnfr_Ec"; // <-- PASTE YOUR GEMINI API KEY HERE

            if (!apiKey) {
                if (!hasShownApiKeyWarning) {
                    openConfirmModal("API Key Missing", "AI features are disabled. Please add a Google Gemini API key to the script to enable them.", () => { closeConfirmModal(); });
                    confirmModalConfirmBtn.textContent = "OK";
                    confirmModalConfirmBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    confirmModalConfirmBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    confirmModalCancelBtn.classList.add('hidden');
                    hasShownApiKeyWarning = true;
                }
                console.warn("Gemini API key is missing. Skipping API call.");
                return null;
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: generationConfig
            };

            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API Error: ${response.status}`);
            const result = await response.json();
            return result.candidates?.[0]?.content?.parts?.[0]?.text;
        }

        async function validateTaskWithGemini(userQuery, showLoadingUI = true) {
            if (showLoadingUI) {
                addTaskBtn.disabled = true;
                suggestTasksBtn.disabled = true;
                addTaskBtn.innerHTML = `<span class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></span>`;
            }

            try {
                const systemPrompt = `You are a task validation assistant. Analyze the user's input to determine if it is a meaningful, actionable task or just gibberish/nonsense like "hahah" or "asdfasdf". Respond with a JSON object with a single boolean key "isValid".`;
                const generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: { type: "OBJECT", properties: { "isValid": { "type": "BOOLEAN" } } }
                };
                const jsonText = await callGemini(`Input: "${userQuery}"`, systemPrompt, generationConfig);

                if (jsonText === null) return true; // Bypass if API key is missing
                return jsonText ? JSON.parse(jsonText).isValid : false;

            } catch (error) {
                console.error("Error validating task:", error);
                return true; 
            } finally {
                if (showLoadingUI) {
                    addTaskBtn.disabled = false;
                    suggestTasksBtn.disabled = false;
                    addTaskBtn.innerHTML = `Add`;
                }
            }
        }

        async function getTaskSuggestions(userQuery) {
            suggestTasksBtn.disabled = true; 
            addTaskBtn.disabled = true; 
            suggestTasksBtn.innerHTML = `<span class="animate-spin">⏳</span> Thinking...`;
            
            try {
                const systemPrompt = `You are a productivity assistant. Break down the user's task into 3-5 simple, actionable sub-tasks. Respond ONLY with a valid JSON array of strings. Example: for "Plan a vacation", respond with ["Research destinations", "Create a budget", "Book flights and hotel", "Plan daily itinerary"].`;
                const generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: { type: "ARRAY", items: { type: "STRING" } }
                };
                const jsonText = await callGemini(`User's task is: "${userQuery}"`, systemPrompt, generationConfig);

                if (jsonText === null) return; // Stop if API key is missing

                if (jsonText) {
                    const subTasks = JSON.parse(jsonText);
                    if (Array.isArray(subTasks)) {
                        renderSuggestions(subTasks, 'ai');
                    }
                }
            } catch (error) { 
                console.error("Error fetching task suggestions:", error); 
                openConfirmModal("Suggestion Failed", "There was an error getting suggestions. Please check the console for details.", () => { closeConfirmModal(); });
            } finally { 
                suggestTasksBtn.disabled = false; 
                addTaskBtn.disabled = false; 
                suggestTasksBtn.innerHTML = `<span class="sparkle">✨</span> Suggest`; 
            }
        }
        
        // --- Customization Logic ---
        function applyTheme(themeName) {
            const theme = themes[themeName];
            if (!theme) return;
            for (const [key, value] of Object.entries(theme)) {
                document.documentElement.style.setProperty(key, value);
            }
            state.customization.theme = themeName;
            saveState();
        }

        function applyFont(fontName) {
            document.body.classList.remove('font-inter', 'font-roboto-mono', 'font-lora');
            document.body.classList.add(`font-${fontName}`);
            state.customization.font = fontName;
            saveState();
        }

        function applyBackground(bgUrl) {
            document.body.style.backgroundImage = `linear-gradient(rgba(13, 17, 23, 0.7), rgba(13, 17, 23, 0.8)), url('${bgUrl}')`;
            state.customization.background = bgUrl;
            saveState();
        }

        // --- Event Listeners ---
        taskForm.addEventListener('submit', async (e) => { e.preventDefault(); await addTask(taskInput.value); });
        suggestTasksBtn.addEventListener('click', async () => { const taskText = taskInput.value; if (!taskText.trim()) { taskInput.focus(); taskInput.placeholder = "Please enter a task first!"; return; } await getTaskSuggestions(taskText); });
        
        suggestionsContainer.addEventListener('click', (e) => {
            const suggestionBtn = e.target.closest('.suggestion-btn');
            if (suggestionBtn) {
                addTask(suggestionBtn.textContent);
            }
            if (e.target.id === 'clear-ai-suggestions') {
                suggestionsContainer.innerHTML = '';
            }
        });

        taskList.addEventListener('click', (e) => {
            const target = e.target;
            const checkboxLabel = target.closest('label[for^="task-"]');
            
            if (checkboxLabel) {
                const checkbox = document.getElementById(checkboxLabel.getAttribute('for'));
                if (checkbox && !checkbox.disabled) {
                    const index = parseInt(checkbox.dataset.index);
                    toggleTask(index, checkbox);
                }
                return;
            }

            const button = target.closest('button[data-index]');
            if (button) {
                const index = parseInt(button.dataset.index);
                if (button.classList.contains('delete-btn')) {
                    deleteTask(index);
                } else if (button.classList.contains('view-proof-btn')) {
                    openViewProofModal(index);
                } else if (button.classList.contains('start-timer-btn')) {
                    startTimer(index);
                } else if (button.classList.contains('pause-timer-btn')) {
                    pauseTimer(index);
                } else if (button.classList.contains('reset-timer-btn')) {
                    resetTimer(index);
                }
            }
        });
        
        bottomNav.addEventListener('click', (e) => {
            const viewBtn = e.target.closest('.nav-btn');
            if (viewBtn) {
                navigateTo(viewBtn.dataset.view);
                saveState();
            }
        });

        // Fitness Listeners
        increaseWaterBtn.addEventListener('click', () => {
            getTodaysFitnessData().waterIntake++;
            saveState();
            renderFitnessView();
        });

        decreaseWaterBtn.addEventListener('click', () => {
            const fitnessData = getTodaysFitnessData();
            if (fitnessData.waterIntake > 0) {
                fitnessData.waterIntake--;
                saveState();
                renderFitnessView();
            }
        });

        increaseMindfulnessBtn.addEventListener('click', () => {
            getTodaysFitnessData().mindfulMinutes += 5; 
            saveState();
            renderFitnessView();
        });

        decreaseMindfulnessBtn.addEventListener('click', () => {
            const fitnessData = getTodaysFitnessData();
            if (fitnessData.mindfulMinutes > 0) {
                fitnessData.mindfulMinutes = Math.max(0, fitnessData.mindfulMinutes - 5);
                saveState();
                renderFitnessView();
            }
        });

        moodTracker.addEventListener('click', (e) => {
            const moodBtn = e.target.closest('.mood-btn');
            if (moodBtn) {
                getTodaysFitnessData().mood = moodBtn.dataset.mood;
                saveState();
                renderFitnessView();
            }
        });

        saveActivityBtn.addEventListener('click', () => {
            getTodaysFitnessData().activity = activityInput.value;
            saveState();
            saveActivityBtn.textContent = "Saved!";
            setTimeout(() => { saveActivityBtn.textContent = "Save Activity"; }, 1500);
        });

        calculateBmiBtn.addEventListener('click', () => {
            const fitnessData = getTodaysFitnessData();
            const feet = parseInt(heightFtInput.value) || 0;
            const inches = parseInt(heightInInput.value) || 0;
            const weight = parseInt(weightKgInput.value) || 0;

            fitnessData.heightFt = feet;
            fitnessData.heightIn = inches;
            fitnessData.weightKg = weight;
            saveState();

            if (weight > 0 && (feet > 0 || inches > 0)) {
                const totalInches = (feet * 12) + inches;
                const heightInMeters = totalInches * 0.0254;
                const bmi = weight / (heightInMeters * heightInMeters);
                const bmiValue = bmi.toFixed(1);

                let category = '';
                let colorClass = '';

                if (bmi < 18.5) {
                    category = 'Underweight';
                    colorClass = 'text-blue-400';
                } else if (bmi >= 18.5 && bmi < 25) {
                    category = 'Normal weight';
                    colorClass = 'text-green-400';
                } else if (bmi >= 25 && bmi < 30) {
                    category = 'Overweight';
                    colorClass = 'text-yellow-400';
                } else {
                    category = 'Obesity';
                    colorClass = 'text-red-400';
                }

                bmiResultValue.textContent = bmiValue;
                bmiResultCategory.textContent = category;
                bmiResultCategory.className = `font-semibold ${colorClass}`;
                bmiResultContainer.classList.remove('hidden');

            } else {
                bmiResultContainer.classList.add('hidden');
            }
        });
        
        // Shop Listeners
        buyStreakFreezeBtn.addEventListener('click', () => {
            const price = 50;
            if (state.gems >= price) {
                state.gems -= price;
                state.streakFreezes++;
                saveState();
                renderShopView();
                updateGemDisplay();
            }
        });

        // Settings Listeners
        streakGoalInput.addEventListener('change', (e) => {
            const newGoal = parseInt(e.target.value);
            if (newGoal >= 1) {
                state.streakGoal = newGoal;
                saveState();
                renderAll();
            }
        });

        clearDataBtn.addEventListener('click', () => {
             openConfirmModal(
                'Clear All Data?',
                'Are you sure you want to delete all your data? This cannot be undone.',
                () => {
                    localStorage.removeItem('momentumState');
                    state.tasks = []; // Clear tasks before loading
                    loadState();
                    applyTheme(state.customization.theme); // Re-apply default theme
                    applyFont(state.customization.font);
                    applyBackground(state.customization.background);
                    renderAll();
                    closeConfirmModal();
                }
            );
            confirmModalConfirmBtn.textContent = "Confirm";
            confirmModalConfirmBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            confirmModalConfirmBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            confirmModalCancelBtn.classList.remove('hidden');
        });
        
        // Customization Listeners
        themeSwatches.addEventListener('click', (e) => {
            const swatch = e.target.closest('.theme-swatch');
            if (swatch) {
                applyTheme(swatch.dataset.theme);
                renderSettingsView();
            }
        });

        fontButtons.addEventListener('click', (e) => {
            const btn = e.target.closest('.font-btn');
            if (btn) {
                applyFont(btn.dataset.font);
                renderSettingsView();
            }
        });

        bgThumbnails.addEventListener('click', (e) => {
            const thumb = e.target.closest('.bg-thumbnail');
            if (thumb) {
                applyBackground(thumb.dataset.bg);
                renderSettingsView();
            }
        });

        applyCustomBgBtn.addEventListener('click', () => {
            const url = customBgInput.value.trim();
            if (url) {
                applyBackground(url);
                renderSettingsView();
            }
        });

        // Proof Modal Listeners
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        proofFileInput.addEventListener('change', () => {
            const file = proofFileInput.files[0];
            if (file) {
                fileNameDisplay.textContent = file.name;
            } else {
                fileNameDisplay.textContent = '';
            }
        });

        confirmProofBtn.addEventListener('click', async () => {
            if (currentTaskIndex !== null) {
                const task = state.tasks[currentTaskIndex];
                const file = proofFileInput.files[0];

                task.completed = true;
                task.proof = proofInput.value.trim() || "Completed";
                task.proofFile = null;

                if (file) {
                    try {
                        const base64String = await fileToBase64(file);
                        task.proofFile = { name: file.name, data: base64String };
                    } catch (error) {
                        console.error("Error reading file:", error);
                    }
                }
                
                state.totalTasksCompleted++;
                awardPoints(task, document.querySelector(`#task-list > div:nth-child(${currentTaskIndex + 1})`));
                updateCompletionHistory(task);
                checkStreak();
                saveState();
                closeProofModal();
                renderAll();
                setTimeout(showFactModal, 500);
            }
        });
        cancelProofBtn.addEventListener('click', closeProofModal);
        
        closeViewProofBtn.addEventListener('click', closeViewProofModal);

        confirmModalCancelBtn.addEventListener('click', closeConfirmModal);
        confirmModalConfirmBtn.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
        });

        closeFactBtn.addEventListener('click', closeFactModal);

        // Chart Listeners
        chartDropdownBtn.addEventListener('click', () => {
            chartDropdownMenu.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!chartDropdownBtn.contains(e.target) && !chartDropdownMenu.contains(e.target)) {
                chartDropdownMenu.classList.add('hidden');
            }
        });

        chartDropdownMenu.addEventListener('click', (e) => {
            e.preventDefault();
            const target = e.target.closest('.chart-period-option');
            if (target) {
                currentChartPeriod = target.dataset.period;
                chartDropdownLabel.textContent = target.textContent;
                chartDropdownMenu.classList.add('hidden');
                renderChart(currentChartPeriod);
            }
        });
        
        // Chart Logic
        function renderChart(period) {
            if (taskChart) {
                taskChart.destroy();
            }
            
            let chartData = { labels: [], data: [] };
            
            if (period === 'today') {
                const today = getTodayDateString();
                const labels = Array.from({ length: 24 }, (_, i) => `${i}:00`);
                const data = Array(24).fill(0);
                state.tasks.forEach(task => {
                    if (task.completed && task.completionTimestamp && task.completionTimestamp.startsWith(today)) {
                        const hour = new Date(task.completionTimestamp).getHours();
                        data[hour]++;
                    }
                });
                chartData = { labels, data };
            } else if (period === 'week') {
                const labels = [];
                const data = [];
                const today = new Date();
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - today.getDay());
                for (let i = 0; i < 7; i++) {
                    const day = new Date(startOfWeek);
                    day.setDate(startOfWeek.getDate() + i);
                    labels.push(day.toLocaleDateString('en-US', { weekday: 'short' }));
                    const dateString = day.toISOString().split('T')[0];
                    data.push(state.completionHistory[dateString] || 0);
                }
                chartData = { labels, data };
            } else if (period === 'month') {
                const labels = [];
                const data = [];
                const today = new Date();
                const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                for (let i = 1; i <= daysInMonth; i++) {
                    labels.push(i);
                    const date = new Date(today.getFullYear(), today.getMonth(), i);
                    const dateString = date.toISOString().split('T')[0];
                    data.push(state.completionHistory[dateString] || 0);
                }
                chartData = { labels, data };
            } else if (period === 'year') {
                const labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const data = Array(12).fill(0);
                const currentYear = new Date().getFullYear();
                for (const dateString in state.completionHistory) {
                    const date = new Date(dateString);
                    if (date.getFullYear() === currentYear) {
                        const month = date.getMonth();
                        data[month] += state.completionHistory[dateString];
                    }
                }
                chartData = { labels, data };
            }

            taskChart = new Chart(taskChartCanvas, {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Tasks Completed',
                        data: chartData.data,
                        backgroundColor: 'rgba(45, 212, 191, 0.5)',
                        borderColor: 'rgba(45, 212, 191, 1)',
                        borderWidth: 1,
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#8B949E',
                                stepSize: 1
                            },
                            grid: {
                                color: '#30363D'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#8B949E'
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            loadState();
            applyTheme(state.customization.theme);
            applyFont(state.customization.font);
            applyBackground(state.customization.background);
            await cleanUpExistingTasks();
            renderAll();
            lucide.createIcons();
        });
    </script>
</body>
</html>

