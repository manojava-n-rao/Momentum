<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Momentum - Reclaim Your Focus And Live Better</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            padding-bottom: 80px; /* Space for the bottom nav */
        }
        .task-item-enter {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .streak-pulse {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .sparkle {
            animation: sparkle-animation 2s ease-in-out infinite;
        }
        @keyframes sparkle-animation {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.8; }
        }
        .shake {
            animation: shake-animation 0.4s;
        }
        @keyframes shake-animation {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }
        .modal-enter {
            animation: modal-fade-in 0.2s ease-out;
        }
        @keyframes modal-fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-content-enter {
            animation: modal-content-slide-in 0.2s ease-out;
        }
        @keyframes modal-content-slide-in {
            from { transform: translateY(20px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        .day-circle.completed {
            background-color: #22c55e; /* green-500 */
            border-color: #16a34a; /* green-600 */
            color: #ffffff;
        }
        .day-circle.today {
             border-color: #6366f1; /* indigo-500 */
        }
        .nav-btn.active {
            color: #818cf8; /* indigo-400 */
        }
        .mood-btn.selected {
            background-color: #4f46e5; /* indigo-600 */
            transform: scale(1.2);
        }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">
    <!-- Loading Overlay for startup cleanup -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 hidden">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-indigo-400 mx-auto"></div>
            <p id="loading-message" class="text-white text-lg mt-4">Loading...</p>
        </div>
    </div>
    
    <!-- Proof of Completion Modal -->
    <div id="proof-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-40 hidden modal-enter">
        <div class="bg-gray-800 rounded-xl p-6 w-11/12 max-w-md shadow-lg border border-gray-700 modal-content-enter">
            <h2 class="text-2xl font-bold mb-4 text-white">Proof of Completion</h2>
            <p class="text-gray-400 mb-4">For task: "<span id="proof-task-name" class="font-semibold text-indigo-300"></span>"</p>
            <textarea id="proof-input" placeholder="How did you complete this? (e.g., 'Finished the report and sent it.')" class="w-full bg-gray-700 text-white placeholder-gray-500 rounded-lg p-3 h-28 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition"></textarea>
            
            <div class="mt-4">
                <label for="proof-file-input" class="w-full text-center bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition cursor-pointer inline-block">
                    📎 Attach File (Optional)
                </label>
                <input type="file" id="proof-file-input" class="hidden">
                <p id="file-name-display" class="text-sm text-gray-500 mt-2 text-center truncate"></p>
            </div>

            <div class="flex justify-end gap-3 mt-4">
                <button id="cancel-proof-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition">Cancel</button>
                <button id="confirm-proof-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition">Complete Task</button>
            </div>
        </div>
    </div>
    
    <!-- View Proof Modal -->
    <div id="view-proof-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-40 hidden modal-enter">
        <div class="bg-gray-800 rounded-xl p-6 w-11/12 max-w-md shadow-lg border border-gray-700 modal-content-enter">
            <h2 class="text-2xl font-bold mb-4 text-white">Task Proof</h2>
            <p class="text-gray-400 mb-2">For task: "<span id="view-proof-task-name" class="font-semibold text-indigo-300"></span>"</p>
            
            <div id="view-proof-file-container" class="mb-3"></div>
            
            <div class="bg-gray-700 rounded-lg p-3">
                <p id="view-proof-text" class="text-white whitespace-pre-wrap"></p>
            </div>
            <div class="flex justify-end mt-4">
                <button id="close-view-proof-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition">Close</button>
            </div>
        </div>
    </div>

    <!-- Generic Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 hidden modal-enter">
        <div class="bg-gray-800 rounded-xl p-6 w-11/12 max-w-sm shadow-lg border border-gray-700 modal-content-enter text-center">
            <h2 id="confirm-modal-title" class="text-xl font-bold mb-3 text-white">Are you sure?</h2>
            <p id="confirm-modal-text" class="text-gray-400 mb-6">This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-modal-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition">Cancel</button>
                <button id="confirm-modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- Header -->
    <header class="text-center my-6 container mx-auto max-w-lg px-4">
        <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-indigo-500">Momentum</h1>
        <p class="text-gray-400 mt-2">Reclaim your day, one task at a time.</p>
    </header>

    <!-- Page Views Container -->
    <div id="page-container">
        <!-- Today View -->
        <div id="today-view" class="page-view container mx-auto max-w-lg p-4">
            <!-- Stats Container -->
            <div class="bg-gray-800 rounded-xl p-6 mb-6 shadow-lg border border-gray-700">
                <!-- Streak Display -->
                <div class="flex items-center justify-center space-x-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-orange-400 streak-flame"><path d="M10.6.9c-2.4 2.4-2.4 6.4 0 8.7l4.3-4.3c-2.3-2.4-6.3-2.4-8.6 0l.1-.1"></path><path d="m14.8 13.4 4.3-4.3c2.4 2.4 2.4 6.4 0 8.7L18.9 18"></path><path d="M13.4 14.8 4.7 6.1A6.13 6.13 0 0 0 4.6 15l.1.1 8.7-8.7"></path><path d="M.9 10.6c2.4-2.4 6.4-2.4 8.7 0l-4.3 4.3c-2.4-2.3-2.4-6.3 0-8.6l-.1.1"></path><path d="m6.1 4.7 8.7 8.7.1-.1a6.13 6.13 0 0 0-8.9-8.8Z"></path></svg>
                    <div>
                        <span id="streak-count" class="text-5xl font-extrabold text-white">0</span>
                        <p class="text-gray-400 font-medium">Day Streak</p>
                    </div>
                </div>
                <p id="streak-message" class="text-center text-indigo-300 mt-4 text-sm font-medium">Complete at least 3 tasks today to keep your streak alive!</p>
                
                <!-- Weekly Progress -->
                <div class="mt-6 pt-6 border-t border-gray-700">
                    <h3 class="text-center font-semibold text-gray-300 mb-3">This Week's Momentum</h3>
                    <div id="weekly-progress-container" class="flex justify-around">
                        <!-- Day circles will be injected here by JS -->
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <main>
                <div id="task-list" class="space-y-3">
                    <!-- Tasks will be injected here by JavaScript -->
                </div>
                <p id="empty-state" class="text-center text-gray-500 py-10 hidden">Your day is clear. Add a task to get started!</p>
            </main>

            <!-- Task Input -->
            <footer class="mt-6">
                <form id="task-form" class="flex items-center gap-2">
                    <input type="text" id="task-input" placeholder="e.g., Plan my weekend trip" class="w-full bg-gray-700 text-white placeholder-gray-400 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                    <button type="submit" id="add-task-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg transition-transform duration-200 active:scale-95 whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed">Add</button>
                    <button type="button" id="suggest-tasks-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-5 rounded-lg transition-transform duration-200 active:scale-95 flex items-center gap-2 whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed">
                        <span class="sparkle">✨</span> Suggest
                    </button>
                </form>
            </footer>
        </div>

        <!-- Journey View -->
        <div id="journey-view" class="page-view container mx-auto max-w-lg p-4 hidden">
             <div class="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700">
                <h2 class="text-2xl font-bold mb-4 text-white text-center">Your Journey</h2>
                <div id="journey-list" class="space-y-4">
                    <!-- Journey items will be injected here -->
                </div>
                 <p id="journey-empty-state" class="text-center text-gray-500 py-10 hidden">Complete a day's tasks to start your journey!</p>
            </div>
        </div>

        <!-- Fitness View -->
        <div id="fitness-view" class="page-view container mx-auto max-w-lg p-4 hidden">
            <div class="space-y-6">
                <h2 class="text-2xl font-bold text-white text-center">Fitness & Wellbeing</h2>

                <!-- BMI Calculator Card -->
                <div class="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700">
                    <h3 class="font-semibold text-lg mb-4 text-center text-white">⚖️ BMI Calculator</h3>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="height-ft-input" class="block text-sm font-medium text-gray-400">Height (ft)</label>
                            <input type="number" id="height-ft-input" class="mt-1 bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5" placeholder="5">
                        </div>
                        <div>
                            <label for="height-in-input" class="block text-sm font-medium text-gray-400">Height (in)</label>
                            <input type="number" id="height-in-input" class="mt-1 bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5" placeholder="9">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="weight-kg-input" class="block text-sm font-medium text-gray-400">Weight (kg)</label>
                        <input type="number" id="weight-kg-input" class="mt-1 bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5" placeholder="70">
                    </div>
                    <button id="calculate-bmi-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition active:scale-95">Calculate BMI</button>
                    <div id="bmi-result-container" class="text-center mt-4 hidden">
                        <p class="text-gray-400">Your BMI is:</p>
                        <p id="bmi-result-value" class="text-3xl font-bold text-white"></p>
                        <p id="bmi-result-category" class="font-semibold"></p>
                    </div>
                </div>

                <!-- Water Intake Card -->
                <div class="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700">
                    <h3 class="font-semibold text-lg mb-4 text-center text-white">💧 Water Intake</h3>
                    <div class="flex items-center justify-center gap-4">
                        <button id="decrease-water-btn" class="bg-gray-700 hover:bg-gray-600 rounded-full h-12 w-12 text-2xl font-bold flex items-center justify-center transition active:scale-95">-</button>
                        <div id="water-intake-display" class="text-4xl font-bold w-24 text-center">0</div>
                        <button id="increase-water-btn" class="bg-gray-700 hover:bg-gray-600 rounded-full h-12 w-12 text-2xl font-bold flex items-center justify-center transition active:scale-95">+</button>
                    </div>
                    <p class="text-center text-gray-400 mt-2">glasses</p>
                </div>

                <!-- Mindful Minutes Card -->
                <div class="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700">
                     <h3 class="font-semibold text-lg mb-4 text-center text-white">🧘 Mindful Minutes</h3>
                     <div class="flex items-center justify-center gap-4">
                        <button id="decrease-mindfulness-btn" class="bg-gray-700 hover:bg-gray-600 rounded-full h-12 w-12 text-2xl font-bold flex items-center justify-center transition active:scale-95">-</button>
                        <div id="mindfulness-display" class="text-4xl font-bold w-24 text-center">0</div>
                        <button id="increase-mindfulness-btn" class="bg-gray-700 hover:bg-gray-600 rounded-full h-12 w-12 text-2xl font-bold flex items-center justify-center transition active:scale-95">+</button>
                    </div>
                    <p class="text-center text-gray-400 mt-2">minutes</p>
                </div>

                <!-- Mood Tracker Card -->
                <div class="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700">
                     <h3 class="font-semibold text-lg mb-4 text-center text-white">😊 Daily Mood</h3>
                     <div id="mood-tracker" class="flex justify-around">
                         <button data-mood="happy" class="mood-btn text-4xl p-2 rounded-full transition-transform duration-200">😄</button>
                         <button data-mood="neutral" class="mood-btn text-4xl p-2 rounded-full transition-transform duration-200">😐</button>
                         <button data-mood="sad" class="mood-btn text-4xl p-2 rounded-full transition-transform duration-200">😔</button>
                         <button data-mood="excited" class="mood-btn text-4xl p-2 rounded-full transition-transform duration-200">🤩</button>
                         <button data-mood="tired" class="mood-btn text-4xl p-2 rounded-full transition-transform duration-200">😴</button>
                     </div>
                </div>

                 <!-- Daily Activity Card -->
                <div class="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700">
                    <h3 class="font-semibold text-lg mb-2 text-center text-white">🏃 Today's Activity</h3>
                    <textarea id="activity-input" placeholder="e.g., 30 min run, evening walk..." class="w-full bg-gray-700 text-white placeholder-gray-500 rounded-lg p-3 h-24 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition"></textarea>
                    <button id="save-activity-btn" class="w-full mt-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition active:scale-95">Save Activity</button>
                </div>
            </div>
        </div>

        <!-- Settings View -->
        <div id="settings-view" class="page-view container mx-auto max-w-lg p-4 hidden">
            <div class="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700 space-y-6">
                <h2 class="text-2xl font-bold text-white text-center">Settings</h2>
                
                <div>
                    <label for="streak-goal-input" class="block mb-2 text-sm font-medium text-gray-300">Daily Streak Goal</label>
                    <input type="number" id="streak-goal-input" min="1" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5" placeholder="3">
                </div>

                <div>
                    <h3 class="text-lg font-semibold text-red-400">Danger Zone</h3>
                    <p class="text-sm text-gray-400 mb-3">This action cannot be undone.</p>
                    <button id="clear-data-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">Clear All App Data</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700">
        <div class="flex justify-around max-w-lg mx-auto">
            <button data-view="today" class="nav-btn active flex-1 p-4 text-center font-semibold text-gray-400 transition">Today</button>
            <button data-view="journey" class="nav-btn flex-1 p-4 text-center font-semibold text-gray-400 transition">Journey</button>
            <button data-view="fitness" class="nav-btn flex-1 p-4 text-center font-semibold text-gray-400 transition">Fitness</button>
            <button data-view="settings" class="nav-btn flex-1 p-4 text-center font-semibold text-gray-400 transition">Settings</button>
        </div>
    </nav>


    <script>
        // DOM Elements
        const taskForm = document.getElementById('task-form');
        const taskInput = document.getElementById('task-input');
        const taskList = document.getElementById('task-list');
        const emptyState = document.getElementById('empty-state');
        const streakCountEl = document.getElementById('streak-count');
        const streakMessageEl = document.getElementById('streak-message');
        const weeklyProgressContainer = document.getElementById('weekly-progress-container');
        const addTaskBtn = document.getElementById('add-task-btn');
        const suggestTasksBtn = document.getElementById('suggest-tasks-btn');
        // Page elements
        const pageContainer = document.getElementById('page-container');
        const bottomNav = document.getElementById('bottom-nav');
        // Journey elements
        const journeyList = document.getElementById('journey-list');
        const journeyEmptyState = document.getElementById('journey-empty-state');
        // Fitness elements
        const decreaseWaterBtn = document.getElementById('decrease-water-btn');
        const increaseWaterBtn = document.getElementById('increase-water-btn');
        const waterIntakeDisplay = document.getElementById('water-intake-display');
        const decreaseMindfulnessBtn = document.getElementById('decrease-mindfulness-btn');
        const increaseMindfulnessBtn = document.getElementById('increase-mindfulness-btn');
        const mindfulnessDisplay = document.getElementById('mindfulness-display');
        const moodTracker = document.getElementById('mood-tracker');
        const activityInput = document.getElementById('activity-input');
        const saveActivityBtn = document.getElementById('save-activity-btn');
        // BMI Calculator elements
        const heightFtInput = document.getElementById('height-ft-input');
        const heightInInput = document.getElementById('height-in-input');
        const weightKgInput = document.getElementById('weight-kg-input');
        const calculateBmiBtn = document.getElementById('calculate-bmi-btn');
        const bmiResultContainer = document.getElementById('bmi-result-container');
        const bmiResultValue = document.getElementById('bmi-result-value');
        const bmiResultCategory = document.getElementById('bmi-result-category');
        // Settings elements
        const streakGoalInput = document.getElementById('streak-goal-input');
        const clearDataBtn = document.getElementById('clear-data-btn');
        // Proof Modal Elements
        const proofModal = document.getElementById('proof-modal');
        const proofTaskName = document.getElementById('proof-task-name');
        const proofInput = document.getElementById('proof-input');
        const proofFileInput = document.getElementById('proof-file-input');
        const fileNameDisplay = document.getElementById('file-name-display');
        const cancelProofBtn = document.getElementById('cancel-proof-btn');
        const confirmProofBtn = document.getElementById('confirm-proof-btn');
        // View Proof Modal Elements
        const viewProofModal = document.getElementById('view-proof-modal');
        const viewProofTaskName = document.getElementById('view-proof-task-name');
        const viewProofText = document.getElementById('view-proof-text');
        const viewProofFileContainer = document.getElementById('view-proof-file-container');
        const closeViewProofBtn = document.getElementById('close-view-proof-btn');
        // Confirmation Modal Elements
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalText = document.getElementById('confirm-modal-text');
        const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn');
        const confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm-btn');

        // App State
        let state = {
            tasks: [],
            streak: 0,
            lastStreakUpdate: null, 
            completionHistory: {}, 
            currentView: 'today',
            streakGoal: 3,
            dailyData: {}, 
        };
        let currentTaskIndex = null; 
        let confirmCallback = null; 
        let hasShownApiKeyWarning = false;

        // --- Date Helpers ---
        function getTodayDateString() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }

        function getYesterdayDateString() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            return yesterday.toISOString().split('T')[0];
        }
        
        // --- State & Storage ---
        function saveState() {
            localStorage.setItem('momentumState', JSON.stringify(state));
        }

        function loadState() {
            const savedState = localStorage.getItem('momentumState');
            const defaultState = {
                tasks: [],
                streak: 0,
                lastStreakUpdate: null, 
                completionHistory: {},
                currentView: 'today',
                streakGoal: 3,
                dailyData: {},
            };

            if (savedState) {
                const loadedState = JSON.parse(savedState);
                state = { ...defaultState, ...loadedState };
            } else {
                state = defaultState;
            }

            const today = getTodayDateString();
            if (!state.dailyData) {
                state.dailyData = {};
            }
            if (!state.dailyData[today]) {
                state.dailyData[today] = {
                    waterIntake: 0,
                    mindfulMinutes: 0,
                    mood: null,
                    activity: '',
                    heightFt: '',
                    heightIn: '',
                    weightKg: ''
                };
            }

            const yesterday = getYesterdayDateString();
            if (state.lastStreakUpdate && state.lastStreakUpdate !== today && state.lastStreakUpdate !== yesterday) {
                state.streak = 0; 
                state.lastStreakUpdate = null;
            }
        }
        
        // --- UI & Rendering ---
        function showLoadingOverlay(message) {
            document.getElementById('loading-message').textContent = message;
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoadingOverlay() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function renderAll() {
            renderTasks();
            updateStreakDisplay();
            renderWeeklyProgress();
            navigateTo(state.currentView, false); 
        }

        function renderTasks() {
            taskList.innerHTML = '';
            emptyState.classList.toggle('hidden', state.tasks.length > 0);

            state.tasks.forEach((task, index) => {
                const taskEl = document.createElement('div');
                taskEl.className = 'task-item-enter bg-gray-800 rounded-lg p-4 flex items-center justify-between shadow-md transition-all duration-300 border border-gray-700';
                if (task.completed) taskEl.classList.add('opacity-50');

                const proofButtonHtml = task.completed && (task.proof || task.proofFile) ? `
                    <button data-index="${index}" class="view-proof-btn text-gray-500 hover:text-indigo-400 transition-colors flex-shrink-0 ml-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    </button>
                ` : '';

                taskEl.innerHTML = `
                    <div class="flex items-center w-full overflow-hidden">
                        <input type="checkbox" id="task-${index}" data-index="${index}" class="h-6 w-6 rounded-full bg-gray-700 border-gray-600 text-indigo-500 focus:ring-indigo-600 flex-shrink-0" ${task.completed ? 'checked' : ''}>
                        <label for="task-${index}" class="ml-4 text-lg truncate ${task.completed ? 'line-through text-gray-500' : 'text-white'}">${task.text}</label>
                    </div>
                    <div class="flex items-center">
                        ${proofButtonHtml}
                        <button data-index="${index}" class="delete-btn text-gray-500 hover:text-red-500 transition-colors flex-shrink-0 ml-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                    </div>
                `;
                taskList.appendChild(taskEl);
            });
        }

        function updateStreakDisplay() {
            streakCountEl.textContent = state.streak;
            const completedToday = state.tasks.filter(t => t.completed).length;

            if (state.streak > 0) {
                streakCountEl.closest('.flex').querySelector('.streak-flame').classList.add('streak-pulse');
            } else {
                streakCountEl.closest('.flex').querySelector('.streak-flame').classList.remove('streak-pulse');
            }
            
            const remaining = state.streakGoal - completedToday;
            if (remaining > 0) {
                streakMessageEl.textContent = `Complete ${remaining} more task${remaining > 1 ? 's' : ''} today to continue your streak!`;
            } else {
                streakMessageEl.textContent = `Great job! You've met your goal for today! 🎉`;
            }
        }

        function renderWeeklyProgress() {
            weeklyProgressContainer.innerHTML = '';
            const dayLabels = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            const today = new Date();
            const todayDateString = today.toISOString().split('T')[0];
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay()); 

            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                const dayDateString = day.toISOString().split('T')[0];

                const completedCount = state.completionHistory[dayDateString] || 0;
                const isCompleted = completedCount >= state.streakGoal;
                const isToday = dayDateString === todayDateString;

                const dayEl = document.createElement('div');
                dayEl.className = 'text-center';
                
                const circleEl = document.createElement('div');
                circleEl.className = 'day-circle h-10 w-10 mx-auto rounded-full border-2 border-gray-600 flex items-center justify-center font-bold transition-all';
                if (isCompleted) circleEl.classList.add('completed');
                if (isToday) circleEl.classList.add('today');
                
                circleEl.textContent = dayLabels[i];
                
                dayEl.appendChild(circleEl);
                weeklyProgressContainer.appendChild(dayEl);
            }
        }

        function renderJourneyView() {
            const completedDays = Object.entries(state.completionHistory)
                .filter(([_, count]) => count >= state.streakGoal)
                .map(([date, count]) => ({ date, count }))
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            journeyList.innerHTML = '';
            journeyEmptyState.classList.toggle('hidden', completedDays.length > 0);

            const moodEmojis = {
                happy: '😄',
                neutral: '😐',
                sad: '😔',
                excited: '🤩',
                tired: '😴'
            };

            completedDays.forEach(({ date, count }) => {
                const dateObj = new Date(date);
                const formattedDate = dateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' });
                const journeyItem = document.createElement('div');
                journeyItem.className = 'bg-gray-700 p-4 rounded-lg';

                let fitnessHtml = '';
                const dailyData = state.dailyData[date];

                if (dailyData) {
                    const fitnessParts = [];
                    if (dailyData.waterIntake > 0) fitnessParts.push(`<span>💧 ${dailyData.waterIntake} glasses</span>`);
                    if (dailyData.mindfulMinutes > 0) fitnessParts.push(`<span>🧘 ${dailyData.mindfulMinutes} min</span>`);
                    if (dailyData.mood) fitnessParts.push(`<span>${moodEmojis[dailyData.mood] || ''}</span>`);
                    
                    if (fitnessParts.length > 0) {
                        fitnessHtml += `<div class="border-t border-gray-600 pt-3 mt-3 flex flex-wrap gap-x-4 gap-y-2 text-sm text-gray-300">${fitnessParts.join('')}</div>`;
                    }
                    if (dailyData.activity) {
                        fitnessHtml += `<p class="w-full mt-2 pt-2 border-t border-gray-600 text-gray-400 italic text-sm">🏃 ${dailyData.activity}</p>`;
                    }
                }

                journeyItem.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-white">${formattedDate}</span>
                        <span class="text-sm font-bold text-green-400">${count} tasks</span>
                    </div>
                    ${fitnessHtml}
                `;
                journeyList.appendChild(journeyItem);
            });
        }

        function getTodaysFitnessData() {
            const today = getTodayDateString();
            if (!state.dailyData[today]) {
                state.dailyData[today] = { waterIntake: 0, mindfulMinutes: 0, mood: null, activity: '', heightFt: '', heightIn: '', weightKg: '' };
            }
            return state.dailyData[today];
        }

        function renderFitnessView() {
            const fitnessData = getTodaysFitnessData();
            
            waterIntakeDisplay.textContent = fitnessData.waterIntake;
            mindfulnessDisplay.textContent = fitnessData.mindfulMinutes;
            activityInput.value = fitnessData.activity;

            heightFtInput.value = fitnessData.heightFt || '';
            heightInInput.value = fitnessData.heightIn || '';
            weightKgInput.value = fitnessData.weightKg || '';

            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.mood === fitnessData.mood);
            });
        }

        function renderSettingsView() {
            streakGoalInput.value = state.streakGoal;
        }

        function navigateTo(viewName, shouldRenderContent = true) {
            state.currentView = viewName;
            document.querySelectorAll('.page-view').forEach(view => view.classList.add('hidden'));
            document.getElementById(`${viewName}-view`).classList.remove('hidden');

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === viewName);
            });

            if(shouldRenderContent) {
                if (viewName === 'journey') renderJourneyView();
                if (viewName === 'settings') renderSettingsView();
                if (viewName === 'fitness') renderFitnessView();
            }
        }
        
        // --- Modal Logic ---
        function openProofModal(index) {
            currentTaskIndex = index;
            const task = state.tasks[index];
            proofTaskName.textContent = task.text;
            proofInput.value = '';
            proofFileInput.value = null;
            fileNameDisplay.textContent = '';
            proofModal.classList.remove('hidden');
        }

        function closeProofModal() {
            proofModal.classList.add('hidden');
            currentTaskIndex = null;
            renderAll(); 
        }

        function openViewProofModal(index) {
            const task = state.tasks[index];
            viewProofTaskName.textContent = task.text;
            viewProofText.textContent = task.proof || "No text proof provided.";
            viewProofFileContainer.innerHTML = '';

            if (task.proofFile && task.proofFile.data) {
                const link = document.createElement('a');
                link.href = task.proofFile.data;
                link.download = task.proofFile.name;
                link.textContent = `📎 Download: ${task.proofFile.name}`;
                link.className = 'inline-block bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition';
                viewProofFileContainer.appendChild(link);
                viewProofFileContainer.classList.remove('hidden');
            } else {
                viewProofFileContainer.classList.add('hidden');
            }

            viewProofModal.classList.remove('hidden');
        }

        function closeViewProofModal() {
            viewProofModal.classList.add('hidden');
        }

        function openConfirmModal(title, text, onConfirm) {
            confirmModalTitle.textContent = title;
            confirmModalText.textContent = text;
            confirmCallback = onConfirm;
            confirmModal.classList.remove('hidden');
        }

        function closeConfirmModal() {
            confirmModal.classList.add('hidden');
            confirmCallback = null;
        }

        // --- Core Task Logic ---
        async function addTask(text) {
            if (!text.trim()) return;
            const isValid = await validateTaskWithGemini(text);
            if (isValid) {
                state.tasks.push({ text, completed: false, proof: null, proofFile: null });
                taskInput.value = '';
                taskInput.placeholder = "e.g., Plan my weekend trip";
                saveState();
                renderAll();
            } else {
                taskInput.value = '';
                taskInput.placeholder = "Please enter a real task...";
                taskInput.classList.add('shake');
                setTimeout(() => taskInput.classList.remove('shake'), 400);
            }
        }

        function toggleTask(index) {
            const task = state.tasks[index];
            if (!task.completed) {
                openProofModal(index);
            } else {
                task.completed = false;
                task.proof = null;
                task.proofFile = null;
                updateCompletionHistory();
                checkStreak(); 
                saveState();
                renderAll();
            }
        }
        
        function deleteTask(index) {
            state.tasks.splice(index, 1);
            updateCompletionHistory();
            checkStreak();
            saveState();
            renderAll();
        }

        function checkStreak() {
            const completedToday = state.tasks.filter(t => t.completed).length;
            const today = getTodayDateString();
            const yesterday = getYesterdayDateString();

            if (completedToday >= state.streakGoal) {
                if (state.lastStreakUpdate !== today) {
                    state.streak = (state.lastStreakUpdate === yesterday) ? state.streak + 1 : 1;
                    state.lastStreakUpdate = today;
                }
            }
        }

        function updateCompletionHistory() {
            const today = getTodayDateString();
            const completedTodayCount = state.tasks.filter(t => t.completed).length;
            state.completionHistory[today] = completedTodayCount;
            saveState();
        }
        
        async function cleanUpExistingTasks() {
            if (state.tasks.length === 0) return;
            showLoadingOverlay("Tidying up your task list...");
            const validationPromises = state.tasks.map(task => validateTaskWithGemini(task.text, false));
            const results = await Promise.all(validationPromises);
            const validatedTasks = state.tasks.filter((_, index) => results[index]);
            if (validatedTasks.length !== state.tasks.length) {
                state.tasks = validatedTasks;
                saveState();
            }
            hideLoadingOverlay();
        }

        // --- GEMINI API ---
        async function callGemini(userQuery, systemPrompt, generationConfig) {
            const apiKey = "AIzaSyABVfkx1OCm6xMreyraOxtp1TDWEnfr_Ec"; // <-- PASTE YOUR GEMINI API KEY HERE

            if (!apiKey) {
                if (!hasShownApiKeyWarning) {
                    openConfirmModal("API Key Missing", "AI features are disabled. Please add a Google Gemini API key to the script to enable them.", () => { closeConfirmModal(); });
                    confirmModalConfirmBtn.textContent = "OK";
                    confirmModalConfirmBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    confirmModalConfirmBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    confirmModalCancelBtn.classList.add('hidden');
                    hasShownApiKeyWarning = true;
                }
                console.warn("Gemini API key is missing. Skipping API call.");
                return null;
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: generationConfig
            };

            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API Error: ${response.status}`);
            const result = await response.json();
            return result.candidates?.[0]?.content?.parts?.[0]?.text;
        }

        async function validateTaskWithGemini(userQuery, showLoadingUI = true) {
            if (showLoadingUI) {
                addTaskBtn.disabled = true;
                suggestTasksBtn.disabled = true;
                addTaskBtn.innerHTML = `<span class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></span>`;
            }

            try {
                const systemPrompt = `You are a task validation assistant. Analyze the user's input to determine if it is a meaningful, actionable task or just gibberish/nonsense like "hahah" or "asdfasdf". Respond with a JSON object with a single boolean key "isValid".`;
                const generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: { type: "OBJECT", properties: { "isValid": { "type": "BOOLEAN" } } }
                };
                const jsonText = await callGemini(`Input: "${userQuery}"`, systemPrompt, generationConfig);

                if (jsonText === null) return true; // Bypass if API key is missing
                return jsonText ? JSON.parse(jsonText).isValid : false;

            } catch (error) {
                console.error("Error validating task:", error);
                return true; 
            } finally {
                if (showLoadingUI) {
                    addTaskBtn.disabled = false;
                    suggestTasksBtn.disabled = false;
                    addTaskBtn.innerHTML = `Add`;
                }
            }
        }

        async function getTaskSuggestions(userQuery) {
            suggestTasksBtn.disabled = true; 
            addTaskBtn.disabled = true; 
            suggestTasksBtn.innerHTML = `<span class="animate-spin">⏳</span> Thinking...`;
            
            try {
                const systemPrompt = `You are a productivity assistant. Break down the user's task into 3-5 simple, actionable sub-tasks. Respond ONLY with a valid JSON array of strings. Example: for "Plan a vacation", respond with ["Research destinations", "Create a budget", "Book flights and hotel", "Plan daily itinerary"].`;
                const generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: { type: "ARRAY", items: { type: "STRING" } }
                };
                const jsonText = await callGemini(`User's task is: "${userQuery}"`, systemPrompt, generationConfig);

                if (jsonText === null) return; // Stop if API key is missing

                if (jsonText) {
                    const subTasks = JSON.parse(jsonText);
                    if (Array.isArray(subTasks)) {
                        subTasks.forEach(taskText => state.tasks.push({ text: taskText, completed: false, proof: null, proofFile: null }));
                        taskInput.value = ''; 
                        saveState(); 
                        renderAll();
                    }
                }
            } catch (error) { 
                console.error("Error fetching task suggestions:", error); 
                openConfirmModal("Suggestion Failed", "There was an error getting suggestions. Please check the console for details.", () => { closeConfirmModal(); });
            } finally { 
                suggestTasksBtn.disabled = false; 
                addTaskBtn.disabled = false; 
                suggestTasksBtn.innerHTML = `<span class="sparkle">✨</span> Suggest`; 
            }
        }

        // --- Event Listeners ---
        taskForm.addEventListener('submit', async (e) => { e.preventDefault(); await addTask(taskInput.value); });
        suggestTasksBtn.addEventListener('click', async () => { const taskText = taskInput.value; if (!taskText.trim()) { taskInput.focus(); taskInput.placeholder = "Please enter a task first!"; return; } await getTaskSuggestions(taskText); });
        
        taskList.addEventListener('click', (e) => {
            const checkbox = e.target.closest('input[type="checkbox"]');
            const deleteBtn = e.target.closest('.delete-btn');
            const viewProofBtn = e.target.closest('.view-proof-btn');

            if (checkbox) {
                const index = parseInt(checkbox.dataset.index);
                toggleTask(index);
            } else if (deleteBtn) {
                const index = parseInt(deleteBtn.dataset.index);
                deleteTask(index);
            } else if (viewProofBtn) {
                const index = parseInt(viewProofBtn.dataset.index);
                openViewProofModal(index);
            }
        });
        
        bottomNav.addEventListener('click', (e) => {
            const viewBtn = e.target.closest('.nav-btn');
            if (viewBtn) {
                navigateTo(viewBtn.dataset.view);
                saveState();
            }
        });

        // Fitness Listeners
        increaseWaterBtn.addEventListener('click', () => {
            getTodaysFitnessData().waterIntake++;
            saveState();
            renderFitnessView();
        });

        decreaseWaterBtn.addEventListener('click', () => {
            const fitnessData = getTodaysFitnessData();
            if (fitnessData.waterIntake > 0) {
                fitnessData.waterIntake--;
                saveState();
                renderFitnessView();
            }
        });

        increaseMindfulnessBtn.addEventListener('click', () => {
            getTodaysFitnessData().mindfulMinutes += 5; 
            saveState();
            renderFitnessView();
        });

        decreaseMindfulnessBtn.addEventListener('click', () => {
            const fitnessData = getTodaysFitnessData();
            if (fitnessData.mindfulMinutes > 0) {
                fitnessData.mindfulMinutes = Math.max(0, fitnessData.mindfulMinutes - 5);
                saveState();
                renderFitnessView();
            }
        });

        moodTracker.addEventListener('click', (e) => {
            const moodBtn = e.target.closest('.mood-btn');
            if (moodBtn) {
                getTodaysFitnessData().mood = moodBtn.dataset.mood;
                saveState();
                renderFitnessView();
            }
        });

        saveActivityBtn.addEventListener('click', () => {
            getTodaysFitnessData().activity = activityInput.value;
            saveState();
            saveActivityBtn.textContent = "Saved!";
            setTimeout(() => { saveActivityBtn.textContent = "Save Activity"; }, 1500);
        });

        calculateBmiBtn.addEventListener('click', () => {
            const fitnessData = getTodaysFitnessData();
            const feet = parseInt(heightFtInput.value) || 0;
            const inches = parseInt(heightInInput.value) || 0;
            const weight = parseInt(weightKgInput.value) || 0;

            fitnessData.heightFt = feet;
            fitnessData.heightIn = inches;
            fitnessData.weightKg = weight;
            saveState();

            if (weight > 0 && (feet > 0 || inches > 0)) {
                const totalInches = (feet * 12) + inches;
                const heightInMeters = totalInches * 0.0254;
                const bmi = weight / (heightInMeters * heightInMeters);
                const bmiValue = bmi.toFixed(1);

                let category = '';
                let colorClass = '';

                if (bmi < 18.5) {
                    category = 'Underweight';
                    colorClass = 'text-blue-400';
                } else if (bmi >= 18.5 && bmi < 25) {
                    category = 'Normal weight';
                    colorClass = 'text-green-400';
                } else if (bmi >= 25 && bmi < 30) {
                    category = 'Overweight';
                    colorClass = 'text-yellow-400';
                } else {
                    category = 'Obesity';
                    colorClass = 'text-red-400';
                }

                bmiResultValue.textContent = bmiValue;
                bmiResultCategory.textContent = category;
                bmiResultCategory.className = `font-semibold ${colorClass}`;
                bmiResultContainer.classList.remove('hidden');

            } else {
                bmiResultContainer.classList.add('hidden');
            }
        });

        // Settings Listeners
        streakGoalInput.addEventListener('change', (e) => {
            const newGoal = parseInt(e.target.value);
            if (newGoal >= 1) {
                state.streakGoal = newGoal;
                saveState();
                renderAll();
            }
        });

        clearDataBtn.addEventListener('click', () => {
             openConfirmModal(
                'Clear All Data?',
                'Are you sure you want to delete all your data? This cannot be undone.',
                () => {
                    localStorage.removeItem('momentumState');
                    loadState(); 
                    renderAll();
                    closeConfirmModal();
                }
            );
            confirmModalConfirmBtn.textContent = "Confirm";
            confirmModalConfirmBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            confirmModalConfirmBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            confirmModalCancelBtn.classList.remove('hidden');
        });
        
        // Proof Modal Listeners
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        proofFileInput.addEventListener('change', () => {
            const file = proofFileInput.files[0];
            if (file) {
                fileNameDisplay.textContent = file.name;
            } else {
                fileNameDisplay.textContent = '';
            }
        });

        confirmProofBtn.addEventListener('click', async () => {
            if (currentTaskIndex !== null) {
                const task = state.tasks[currentTaskIndex];
                const file = proofFileInput.files[0];

                task.completed = true;
                task.proof = proofInput.value.trim() || "Completed";
                task.proofFile = null;

                if (file) {
                    try {
                        const base64String = await fileToBase64(file);
                        task.proofFile = { name: file.name, data: base64String };
                    } catch (error) {
                        console.error("Error reading file:", error);
                    }
                }
                
                updateCompletionHistory();
                checkStreak();
                saveState();
                closeProofModal();
            }
        });
        cancelProofBtn.addEventListener('click', closeProofModal);
        
        closeViewProofBtn.addEventListener('click', closeViewProofModal);

        confirmModalCancelBtn.addEventListener('click', closeConfirmModal);
        confirmModalConfirmBtn.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
        });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            loadState();
            await cleanUpExistingTasks();
            renderAll();
        });
    </script>
</body>
</html>

